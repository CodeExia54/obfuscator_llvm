name: Build Android OLLVM Compiler (AOSP-Compatible)

on:
  workflow_dispatch:

jobs:
  build-android-ollvm:
    runs-on: ubuntu-22.04

    steps:
    # ------------------------------------------------------------
    # Checkout OLLVM source (LLVM 14 + obfuscator patch)
    # ------------------------------------------------------------
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    # ------------------------------------------------------------
    # Apply OLLVM patch
    # ------------------------------------------------------------
    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch

    # ------------------------------------------------------------
    # Install dependencies (AOSP-like host)
    # ------------------------------------------------------------
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          lld \
          zlib1g-dev \
          libxml2-dev \
          binutils

        pip3 install pygments pyyaml

    # ------------------------------------------------------------
    # Configure LLVM (AOSP-compatible, FIXED)
    # ------------------------------------------------------------
    - name: Configure LLVM
      run: |
        mkdir build
        cd build

        cmake ../llvm-project/llvm \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          \
          -DLLVM_ENABLE_PROJECTS="clang;lld;compiler-rt" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \
          \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_ENABLE_BINDINGS=OFF \
          \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_DOCS=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          \
          -DLLVM_ENABLE_TERMINFO=OFF \
          -DLLVM_ENABLE_ZLIB=ON

    # ------------------------------------------------------------
    # Build
    # ------------------------------------------------------------
    - name: Build LLVM
      run: |
        cd build
        ninja -j$(nproc)

    # ------------------------------------------------------------
    # Verify OLLVM passes are present (important)
    # ------------------------------------------------------------
    - name: Verify OLLVM passes
      run: |
        ./build/bin/clang -mllvm -help | grep -E "fla|bcf|sub|sobf" || {
          echo "❌ OLLVM passes not found"
          exit 1
        }
        echo "✅ OLLVM passes detected"

    # ------------------------------------------------------------
    # Package toolchain (AOSP layout)
    # ------------------------------------------------------------
    - name: Package toolchain
      run: |
        mkdir -p android-ollvm/bin
        mkdir -p android-ollvm/lib

        # Binaries
        cp build/bin/clang android-ollvm/bin/
        cp build/bin/clang++ android-ollvm/bin/
        cp build/bin/ld.lld android-ollvm/bin/
        cp build/bin/lld android-ollvm/bin/

        # LLVM tools
        for t in llvm-ar llvm-nm llvm-strip llvm-objcopy llvm-objdump llvm-readelf llvm-ranlib; do
          cp build/bin/$t android-ollvm/bin/ || true
        done

        # Compiler runtime headers (CRITICAL)
        CLANG_VER=$(ls build/lib/clang | head -1)
        mkdir -p android-ollvm/lib/clang/$CLANG_VER
        cp -r build/lib/clang/$CLANG_VER/include android-ollvm/lib/clang/$CLANG_VER/

        # Package
        tar -czf android-ollvm-aosp.tar.gz android-ollvm

    # ------------------------------------------------------------
    # Upload artifact
    # ------------------------------------------------------------
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-aosp
        path: android-ollvm-aosp.tar.gz
        retention-days: 7
