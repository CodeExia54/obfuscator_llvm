name: Build OLLVM Clang for AOSP Kernel Modules

on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'Linux kernel version for testing'
        type: string
        default: '5.15.150'

jobs:
  build-ollvm-clang-aosp:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: true

    - name: Install minimal dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          clang \
          gcc-aarch64-linux-gnu

    - name: Apply Kernel Compatibility Patches Only
      run: |
        echo "=== Applying Minimal Kernel Compatibility ==="
        
        cd llvm-project
        
        # Apply ONLY OLLVM patches (no Android patches needed!)
        echo "Applying OLLVM patches..."
        for patch in ../*.patch; do
          if [ -f "$patch" ]; then
            echo "Applying: $(basename "$patch")"
            patch -p1 -F 3 --no-backup-if-mismatch < "$patch" 2>/dev/null || true
          fi
        done
        
        # Manually add kernel flag support WITHOUT Android patches
        echo "Adding minimal kernel flag support..."
        
        # 1. Enable -mgeneral-regs-only for ARM64
        cat > add_kernel_flags.patch << 'EOF'
        diff --git a/clang/lib/Driver/ToolChains/Arch/AArch64.cpp b/clang/lib/Driver/ToolChains/Arch/AArch64.cpp
        index XXXXXXX..XXXXXXX 100644
        --- a/clang/lib/Driver/ToolChains/Arch/AArch64.cpp
        +++ b/clang/lib/Driver/ToolChains/Arch/AArch64.cpp
        @@ -XXX,XX +XXX,XX @@
         void aarch64::getAArch64TargetFeatures(const Driver &D,
                                                const ArgList &Args,
                                                std::vector<StringRef> &Features) {
        +  // Support kernel flag: -mgeneral-regs-only
        +  if (Args.hasArg(options::OPT_mgeneral_regs_only)) {
        +    Features.push_back("+general-regs-only");
        +  }
        +
        +  // Support kernel flag: -mno-implicit-float  
        +  if (Args.hasArg(options::OPT_mno_implicit_float)) {
        +    Features.push_back("+no-implicit-float");
        +  }
        +
           // Handle -march, -mcpu, -mfpu, -mhwdiv.
           getAArch64ArchFeaturesFromMcpu(D, Args, Features);
        EOF
        
        patch -p1 < add_kernel_flags.patch 2>/dev/null || true

    - name: Build OLLVM Clang Only
      run: |
        echo "=== Building OLLVM Clang (Fast) ==="
        
        cd llvm-project
        mkdir -p build
        cd build
        
        # Build ONLY clang, no LLD, no compiler-rt
        cmake ../llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-gnu" \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_BUILD_TOOLS=OFF \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -G "Ninja"
        
        # Build just clang (fast!)
        ninja clang -j$(nproc)
        
        # Test OLLVM immediately
        echo "=== Testing OLLVM ==="
        ./bin/clang -mllvm -help 2>&1 | grep -E "fla|sub|bcf" \
          && echo "✅ OLLVM passes available" \
          || echo "❌ OLLVM passes missing"

    - name: Download AOSP Kernel for Testing
      run: |
        echo "=== Downloading AOSP Kernel Common ==="
        
        # Download AOSP common kernel (most compatible)
        git clone --depth=1 https://android.googlesource.com/kernel/common
        
        # Create test kernel module
        cat > common/test_module.c << 'EOF'
        #include <linux/module.h>
        #include <linux/kernel.h>
        #include <linux/init.h>
        
        static int __init test_init(void)
        {
            printk(KERN_INFO "OLLVM Test Module Loaded\n");
            return 0;
        }
        
        static void __exit test_exit(void)
        {
            printk(KERN_INFO "OLLVM Test Module Unloaded\n");
        }
        
        module_init(test_init);
        module_exit(test_exit);
        
        MODULE_LICENSE("GPL");
        MODULE_AUTHOR("Test");
        MODULE_DESCRIPTION("OLLVM Kernel Module Test");
        EOF
        
        # Create simple Makefile
        cat > common/Makefile.test << 'EOF'
        obj-m := test_module.o
        
        KDIR := /lib/modules/$(shell uname -r)/build
        PWD := $(shell pwd)
        
        # Android kernel flags
        EXTRA_CFLAGS := -nostdinc \
                        -isystem $(shell $(CC) -print-file-name=include) \
                        -I$(PWD)/include \
                        -I$(PWD)/arch/arm64/include \
                        -I$(PWD)/arch/arm64/include/generated \
                        -D__KERNEL__ \
                        -DMODULE \
                        -Wall \
                        -Wundef \
                        -Wstrict-prototypes \
                        -Wno-trigraphs \
                        -fno-strict-aliasing \
                        -fno-common \
                        -fshort-wchar \
                        -fno-PIC \
                        -mgeneral-regs-only \
                        -mno-implicit-float
        
        all:
        	make -C $(KDIR) M=$(PWD) modules
        
        clean:
        	make -C $(KDIR) M=$(PWD) clean
        EOF

    - name: Test OLLVM with AOSP Kernel Build
      run: |
        echo "=== Testing OLLVM Clang with AOSP Kernel ==="
        
        cd llvm-project/build
        
        # Create test environment
        export OLLVM_CLANG="$(pwd)/bin/clang"
        export PATH="$(pwd)/bin:$PATH"
        
        # Test 1: Basic kernel compilation
        echo "1. Basic kernel module test..."
        
        cat > /tmp/simple_kernel.c << 'EOF'
        #define __KERNEL__
        #define MODULE
        
        int test_function(void) {
            int x = 42;
            int y = x * 2;
            return y;
        }
        EOF
        
        # Try with various kernel flags
        $OLLVM_CLANG \
          --target=aarch64-linux-gnu \
          -nostdinc \
          -D__KERNEL__ \
          -DMODULE \
          -fno-PIC \
          -mgeneral-regs-only \
          -c /tmp/simple_kernel.c \
          -o /tmp/simple_kernel.o
        
        if [ $? -eq 0 ]; then
            echo "✅ Basic kernel flags work"
            file /tmp/simple_kernel.o
        else
            echo "❌ Basic kernel flags fail"
        fi
        
        # Test 2: OLLVM obfuscation with kernel code
        echo ""
        echo "2. Testing OLLVM obfuscation..."
        
        $OLLVM_CLANG \
          --target=aarch64-linux-gnu \
          -nostdinc \
          -D__KERNEL__ \
          -DMODULE \
          -fno-PIC \
          -mgeneral-regs-only \
          -c /tmp/simple_kernel.c \
          -o /tmp/simple_kernel_ollvm.o \
          -mllvm -fla \
          -mllvm -sub
        
        if [ $? -eq 0 ]; then
            echo "✅ OLLVM works with kernel flags"
            # Check if binary is different (obfuscated)
            if ! cmp -s /tmp/simple_kernel.o /tmp/simple_kernel_ollvm.o; then
                echo "✅ OLLVM changed the binary (obfuscation working)"
            else
                echo "⚠️ OLLVM didn't change binary"
            fi
        else
            echo "❌ OLLVM fails with kernel flags"
        fi
        
        # Test 3: Integration with Android toolchain
        echo ""
        echo "3. Integration strategy..."
        
        cat > /tmp/integration_test.sh << 'EOF'
        #!/bin/bash
        # How to use OLLVM clang with Android toolchain
        
        # Your Android toolchain path
        ANDROID_TOOLCHAIN="/opt/ddk/clang/clang-r450784e"
        
        # Your OLLVM clang
        OLLVM_CLANG="$(pwd)/bin/clang"
        
        echo "Method 1: Replace clang only"
        echo "cp '$OLLVM_CLANG' '$ANDROID_TOOLCHAIN/bin/clang.ollvm'"
        echo "make CC='$ANDROID_TOOLCHAIN/bin/clang.ollvm' KCFLAGS='-mllvm -fla -mllvm -sub'"
        
        echo ""
        echo "Method 2: Use as wrapper"
        echo "export CC='$OLLVM_CLANG'"
        echo "export PATH='$ANDROID_TOOLCHAIN/bin:\$PATH'"
        echo "make ARCH=arm64 CROSS_COMPILE=aarch64-linux-android-"
        
        echo ""
        echo "Method 3: Hybrid approach (recommended)"
        echo "# Use Android's ld.lld, llvm-ar, etc. with OLLVM clang"
        echo "make \\"
        echo "  CC='$OLLVM_CLANG' \\"
        echo "  LD='$ANDROID_TOOLCHAIN/bin/ld.lld' \\"
        echo "  AR='$ANDROID_TOOLCHAIN/bin/llvm-ar' \\"
        echo "  KCFLAGS='-mllvm -fla -mllvm -sub'"
        EOF
        
        chmod +x /tmp/integration_test.sh
        cat /tmp/integration_test.sh

    - name: Create OLLVM Clang Package with Integration Scripts
      run: |
        echo "=== Creating OLLVM Clang Package ==="
        
        cd llvm-project/build
        
        mkdir -p ollvm-clang-aosp
        
        # Copy only clang binary
        cp bin/clang ollvm-clang-aosp/
        
        # Create integration scripts
        cat > ollvm-clang-aosp/integrate_with_android.sh << 'EOF'
        #!/bin/bash
        # Integrate OLLVM clang with Android toolchain
        
        if [ -z "$1" ]; then
            echo "Usage: $0 <android_toolchain_path>"
            echo "Example: $0 /opt/ddk/clang/clang-r450784e"
            exit 1
        fi
        
        ANDROID_TOOLCHAIN="$1"
        OLLVM_CLANG="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/clang"
        
        echo "=== Integrating OLLVM Clang with Android Toolchain ==="
        echo "Android Toolchain: $ANDROID_TOOLCHAIN"
        echo "OLLVM Clang: $OLLVM_CLANG"
        
        # Backup original clang
        if [ -f "$ANDROID_TOOLCHAIN/bin/clang" ]; then
            cp "$ANDROID_TOOLCHAIN/bin/clang" "$ANDROID_TOOLCHAIN/bin/clang.backup"
            echo "✅ Backed up original clang"
        fi
        
        # Copy OLLVM clang
        cp "$OLLVM_CLANG" "$ANDROID_TOOLCHAIN/bin/clang.ollvm"
        chmod +x "$ANDROID_TOOLCHAIN/bin/clang.ollvm"
        
        # Create wrapper script that uses OLLVM for modules only
        cat > "$ANDROID_TOOLCHAIN/bin/clang.ollvm-wrapper" << 'WRAPPER_EOF'
        #!/bin/bash
        # Wrapper to use OLLVM only for kernel modules
        
        ANDROID_CLANG="$ANDROID_TOOLCHAIN/bin/clang.backup"
        OLLVM_CLANG="$ANDROID_TOOLCHAIN/bin/clang.ollvm"
        
        # Check if this is kernel/module compilation
        IS_KERNEL=0
        for arg in "$@"; do
            if [[ "$arg" == "-D__KERNEL__" ]] || \
               [[ "$arg" == "-DMODULE" ]] || \
               [[ "$arg" == *".ko" ]] || \
               [[ "$arg" == "-c" ]]; then
                IS_KERNEL=1
                break
            fi
        done
        
        if [ "$IS_KERNEL" -eq 1 ]; then
            # Use OLLVM for kernel code
            echo "[OLLVM] Compiling kernel code with obfuscation" >&2
            exec "$OLLVM_CLANG" "$@" -mllvm -fla -mllvm -sub
        else
            # Use original Android clang for everything else
            exec "$ANDROID_CLANG" "$@"
        fi
        WRAPPER_EOF
        
        chmod +x "$ANDROID_TOOLCHAIN/bin/clang.ollvm-wrapper"
        
        echo ""
        echo "✅ Integration complete!"
        echo ""
        echo "Usage options:"
        echo "1. Use OLLVM for everything:"
        echo "   export CC='$ANDROID_TOOLCHAIN/bin/clang.ollvm'"
        echo "   export KCFLAGS='-mllvm -fla -mllvm -sub'"
        echo ""
        echo "2. Smart wrapper (recommended):"
        echo "   export CC='$ANDROID_TOOLCHAIN/bin/clang.ollvm-wrapper'"
        echo "   # Automatically uses OLLVM only for kernel code"
        echo ""
        echo "3. Manual selection:"
        echo "   # For kernel modules:"
        echo "   make CC='$ANDROID_TOOLCHAIN/bin/clang.ollvm' KCFLAGS='-mllvm -fla'"
        echo "   # For normal code:"
        echo "   make CC='$ANDROID_TOOLCHAIN/bin/clang.backup'"
        EOF
        
        chmod +x ollvm-clang-aosp/integrate_with_android.sh
        
        # Create build example
        cat > ollvm-clang-aosp/example_build.sh << 'EOF'
        #!/bin/bash
        # Example: Build kernel module with OLLVM
        
        # Set paths
        ANDROID_TOOLCHAIN="/opt/ddk/clang/clang-r450784e"
        OLLVM_CLANG="./clang"
        
        # Method 1: Direct replacement
        echo "=== Method 1: Direct OLLVM ==="
        echo "make \\"
        echo "  ARCH=arm64 \\"
        echo "  CC='$OLLVM_CLANG' \\"
        echo "  LD='$ANDROID_TOOLCHAIN/bin/ld.lld' \\"
        echo "  AR='$ANDROID_TOOLCHAIN/bin/llvm-ar' \\"
        echo "  KCFLAGS='-mllvm -fla -mllvm -sub -mllvm -bcf'"
        
        echo ""
        echo "=== Method 2: Use with original clang flags ==="
        echo "# First build kernel normally"
        echo "make ARCH=arm64 CC=$ANDROID_TOOLCHAIN/bin/clang"
        echo ""
        echo "# Then build modules with OLLVM"
        echo "make modules CC='$OLLVM_CLANG' \\"
        echo "  KCFLAGS='-mllvm -fla -mllvm -sub'"
        
        echo ""
        echo "=== Common OLLVM flags ==="
        echo "-mllvm -fla    # Control flow flattening"
        echo "-mllvm -sub    # Instruction substitution"
        echo "-mllvm -bcf    # Bogus control flow"
        echo "-mllvm -sobf   # String obfuscation"
        EOF
        
        chmod +x ollvm-clang-aosp/example_build.sh
        
        # Create package
        tar -czf ollvm-clang-aosp.tar.gz ollvm-clang-aosp/
        
        echo "✅ Package created: ollvm-clang-aosp.tar.gz"
        echo "Includes:"
        echo "  - OLLVM clang binary"
        echo "  - Integration script for Android toolchain"
        echo "  - Example build scripts"

    - name: Upload OLLVM Clang Package
      uses: actions/upload-artifact@v4
      with:
        name: ollvm-clang-aosp
        path: llvm-project/build/ollvm-clang-aosp.tar.gz
