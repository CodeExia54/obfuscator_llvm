name: Build Universal Android OLLVM (All Versions)

on:
  workflow_dispatch:

jobs:
  build-universal-ollvm:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch minimally
      run: |
        cd llvm-project
        # Apply only the OLLVM pass additions, not Android-specific changes
        if [ -f "../obfuscator.patch" ]; then
          # Filter to only OLLVM pass patches
          grep -A 5 -B 5 "Obfuscator\|obfuscator\|fla\|sub\|bcf" ../obfuscator.patch > /tmp/ollvm_only.patch || true
          patch -p1 --no-backup-if-mismatch < /tmp/ollvm_only.patch 2>/dev/null || true
        fi

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          gcc-aarch64-linux-gnu \
          gcc-arm-linux-gnueabi \
          gcc-x86-64-linux-gnu \
          gcc-i686-linux-gnu
        pip3 install pygments pyyaml

    - name: Build Universal OLLVM (Like AOSP)
      run: |
        cd llvm-project
        mkdir -p build
        cd build
        
        echo "=== Building Universal OLLVM (AOSP Style) ==="
        
        # THIS is how AOSP builds clang - GENERIC, not Android-specific
        cmake ../llvm \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          \
          # Build all LLVM components
          -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld;compiler-rt" \
          \
          # Support ALL Android targets
          -DLLVM_TARGETS_TO_BUILD="AArch64;ARM;X86" \
          \
          # Generic target (will be overridden with --target=)
          -DLLVM_DEFAULT_TARGET_TRIPLE="x86_64-unknown-linux-gnu" \
          \
          # Build everything as position-independent
          -DLLVM_ENABLE_PIC=ON \
          \
          # Enable LTO support (for Android kernels that use it)
          -DLLVM_ENABLE_LTO=ON \
          \
          # Use LLVM's own tools for building
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCLANG_DEFAULT_LINKER=lld \
          \
          # Performance optimizations
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          \
          # Optional components
          -DLLVM_ENABLE_ZLIB=ON \
          -DLLVM_ENABLE_TERMINFO=OFF \
          -DLLVM_ENABLE_LIBXML2=OFF
        
        echo "Configuration complete"
        echo ""
        echo "Targets enabled: AArch64, ARM, X86"
        echo "Projects: clang, lld, compiler-rt"
        echo "LTO: Enabled"
        echo "Generic build (like AOSP)"

    - name: Build
      run: |
        cd llvm-project/build
        ninja -j$(nproc)
        
        echo "=== Build Verification ==="
        
        if [ -f "bin/clang" ]; then
          echo "✅ Universal OLLVM built successfully"
          
          # Test multi-target support
          echo ""
          echo "Testing multi-target support:"
          
          TARGETS=(
            "aarch64-linux-android"
            "armv7a-linux-androideabi" 
            "i686-linux-android"
            "x86_64-linux-android"
            "aarch64-linux-gnu"
            "arm-linux-gnueabi"
          )
          
          for target in "${TARGETS[@]}"; do
            echo -n "Target $target: "
            ./bin/clang --target=$target -print-effective-triple 2>&1 | \
              grep -q "error" && echo "❌" || echo "✅"
          done
          
          # Test OLLVM passes
          echo ""
          echo "Testing OLLVM passes:"
          ./bin/clang -mllvm -help 2>&1 | grep -q -i "fla\|sub\|bcf" && \
            echo "✅ OLLVM passes available" || echo "❌ OLLVM passes missing"
        else
          echo "❌ Build failed"
          exit 1
        fi

    - name: Package Universal Toolchain
      run: |
        cd llvm-project/build
        
        # Create AOSP-style directory structure
        mkdir -p android-ollvm-universal/{bin,lib,lib64,prebuilts}
        
        echo "=== Creating Universal AOSP-style Toolchain ==="
        
        # Copy binaries (like AOSP does)
        echo "Copying binaries..."
        cp -L bin/clang android-ollvm-universal/bin/
        cp -L bin/clang++ android-ollvm-universal/bin/
        cp -L bin/ld.lld android-ollvm-universal/bin/
        
        # Copy all LLVM tools
        for tool in bin/llvm-*; do
          [ -f "$tool" ] && cp -L "$tool" android-ollvm-universal/bin/
        done
        
        # Copy runtime libraries
        echo "Copying runtime libraries..."
        if [ -d "lib/clang" ]; then
          CLANG_VER=$(ls lib/clang/ | head -1)
          echo "Clang version: $CLANG_VER"
          
          mkdir -p android-ollvm-universal/lib/clang/$CLANG_VER
          cp -r lib/clang/$CLANG_VER/include android-ollvm-universal/lib/clang/$CLANG_VER/
          
          # Copy libs (like AOSP)
          find lib -name "*.a" -o -name "*.so" | head -10 | while read lib; do
            cp "$lib" android-ollvm-universal/lib/ 2>/dev/null || true
          done
        fi
        
        if [ -d "lib64/clang" ]; then
          mkdir -p android-ollvm-universal/lib64/clang/$CLANG_VER
          cp -r lib64/clang/$CLANG_VER/include android-ollvm-universal/lib64/clang/$CLANG_VER/
        fi
        
        # Create AOSP-style wrapper scripts
        echo "Creating AOSP-style wrappers..."
        
        # clang wrapper (sets default Android target)
        cat > android-ollvm-universal/bin/aarch64-linux-android-clang << 'EOF'
#!/bin/bash
# AOSP-style wrapper for Android clang
exec "$(dirname "$0")/clang" --target=aarch64-linux-android "$@"
EOF
        
        cat > android-ollvm-universal/bin/aarch64-linux-android-clang++ << 'EOF'
#!/bin/bash
exec "$(dirname "$0")/clang++" --target=aarch64-linux-android "$@"
EOF
        
        # Kernel clang wrapper
        cat > android-ollvm-universal/bin/aarch64-linux-gnu-clang << 'EOF'
#!/bin/bash
# For kernel compilation
exec "$(dirname "$0")/clang" --target=aarch64-linux-gnu "$@"
EOF
        
        chmod +x android-ollvm-universal/bin/*-clang*
        
        # Create README with AOSP-style usage
        cat > android-ollvm-universal/README.md << 'EOF'
        # Universal Android OLLVM Toolchain (AOSP-style)
        
        ## Overview
        Built like AOSP's clang - works for ALL Android versions and targets.
        
        ## Supported Targets
        - Android userspace: aarch64-linux-android, armv7a-linux-androideabi
        - Android kernel: aarch64-linux-gnu, arm-linux-gnueabi
        - Desktop: x86_64-linux-gnu, i686-linux-gnu
        
        ## Usage Examples
        
        ### 1. Android Userspace (Apps/Libraries)
        ```bash
        # ARM64 Android app
        aarch64-linux-android-clang -pie -fPIC app.c -o app
        
        # ARM32 Android
        armv7a-linux-androideabi-clang app.c -o app
        ```
        
        ### 2. Android Kernel Modules
        ```bash
        # Method A: Direct with target
        clang --target=aarch64-linux-gnu \
          -nostdinc -D__KERNEL__ \
          -c module.c -o module.o \
          -mllvm -fla -mllvm -sub
        
        # Method B: Using kernel's build system
        make CC="clang --target=aarch64-linux-gnu" \
          KCFLAGS="-mllvm -fla -mllvm -sub"
        ```
        
        ### 3. With Android NDK/Sysroot
        ```bash
        # Point to NDK sysroot
        clang --target=aarch64-linux-android \
          --sysroot=/path/to/ndk/sysroot \
          app.c -o app
        ```
        
        ## Directory Structure (AOSP-style)
        ```
        android-ollvm-universal/
        ├── bin/                    # All binaries
        │   ├── clang              # Main compiler
        │   ├── aarch64-linux-android-clang    # AOSP wrapper
        │   ├── aarch64-linux-gnu-clang        # Kernel wrapper
        │   └── llvm-*             # LLVM tools
        ├── lib/                   # 32-bit libraries
        ├── lib64/                 # 64-bit libraries
        └── README.md
        ```
        
        ## Key Features
        - OLLVM passes: -mllvm -fla, -sub, -bcf
        - Multi-target: Android (all ABIs) + Linux
        - LTO support (for Android kernels)
        - AOSP-compatible
        ```
        
        EOF
        
        # Create test script
        cat > android-ollvm-universal/test_all_targets.sh << 'EOF'
        #!/bin/bash
        echo "=== Testing Universal OLLVM Toolchain ==="
        
        export PATH="$(dirname "$0")/bin:$PATH"
        
        echo ""
        echo "1. Testing Android Userspace Targets:"
        
        ANDROID_TARGETS=(
          "aarch64-linux-android"
          "armv7a-linux-androideabi"
          "i686-linux-android"
          "x86_64-linux-android"
        )
        
        for target in "${ANDROID_TARGETS[@]}"; do
          echo -n "  $target: "
          clang --target=$target -c -x c -o /dev/null - <<< "int main() { return 0; }" 2>&1
          [ $? -eq 0 ] && echo "✅" || echo "❌"
        done
        
        echo ""
        echo "2. Testing Linux/Kernel Targets:"
        
        LINUX_TARGETS=(
          "aarch64-linux-gnu"
          "arm-linux-gnueabi"
          "x86_64-linux-gnu"
        )
        
        for target in "${LINUX_TARGETS[@]}"; do
          echo -n "  $target: "
          clang --target=$target -c -x c -o /dev/null - <<< "int test() { return 0; }" 2>&1
          [ $? -eq 0 ] && echo "✅" || echo "❌"
        done
        
        echo ""
        echo "3. Testing OLLVM Passes:"
        clang -mllvm -help 2>&1 | grep -q -i "fla\|sub\|bcf" && \
          echo "✅ OLLVM passes work" || echo "❌ OLLVM passes missing"
        
        echo ""
        echo "4. Testing with OLLVM:"
        clang -c -x c -o /tmp/test.o - <<< "int func(int x) { return x * 2; }" \
          -mllvm -fla -mllvm -sub 2>&1
        [ $? -eq 0 ] && echo "✅ OLLVM compilation works" || echo "❌ OLLVM compilation failed"
        
        echo ""
        echo "=== Universal Toolchain Ready ==="
        EOF
        
        chmod +x android-ollvm-universal/test_all_targets.sh
        
        # Create package
        tar -czf android-ollvm-universal.tar.gz android-ollvm-universal/
        
        echo ""
        echo "✅ Universal AOSP-style OLLVM built!"
        echo "Package: android-ollvm-universal.tar.gz"
        echo "Size: $(du -h android-ollvm-universal.tar.gz | cut -f1)"

    - name: Upload Universal Toolchain
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-universal
        path: llvm-project/build/android-ollvm-universal.tar.gz
        retention-days: 7

  test-with-android-kernel:
    needs: build-universal-ollvm
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ylarod/ddk:android12-5.10
    
    steps:
    - name: Download and Test Universal OLLVM
      run: |
        echo "=== Testing with Real Android Kernel ==="
        
        # Download the universal OLLVM
        # (In real workflow, this would come from previous job)
        
        # Simpler: Test with kernel's own build
        echo ""
        echo "Testing kernel compatibility..."
        
        # Create test module
        mkdir -p /tmp/test-kernel-module
        cd /tmp/test-kernel-module
        
        cat > test.c << 'EOF'
        #define MODULE
        #define __KERNEL__
        #include <linux/module.h>
        #include <linux/kernel.h>
        
        static int __init test_init(void)
        {
            printk(KERN_INFO "Universal OLLVM test\n");
            return 0;
        }
        
        static void __exit test_exit(void)
        {
            printk(KERN_INFO "Universal OLLVM test exit\n");
        }
        
        module_init(test_init);
        module_exit(test_exit);
        
        MODULE_LICENSE("GPL");
        EOF
        
        cat > Makefile << 'EOF'
        obj-m := test.o
        EOF
        
        # Try building with different approaches
        echo ""
        echo "1. Testing with --target flag:"
        make -C "$KERNEL_SRC" M=$(pwd) clean
        
        # This should work with universal OLLVM
        make -C "$KERNEL_SRC" M=$(pwd) modules \
          CC="clang --target=aarch64-linux-gnu" \
          KCFLAGS="-mllvm -fla" \
          -j1 2>&1 | tail -10
        
        if [ -f "test.ko" ]; then
          echo "✅ Universal OLLVM works with kernel!"
        else
          echo "❌ May need sysroot/include paths"
        fi
