name: Build Android OLLVM Compiler (AOSP-Compatible)

on:
  workflow_dispatch:

jobs:
  build-android-ollvm:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          lld \
          zlib1g-dev \
          libxml2-dev \
          binutils
        pip3 install pygments pyyaml

    - name: Configure LLVM (Kernel-safe)
      run: |
        mkdir build
        cd build

        cmake ../llvm-project/llvm \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \
          \
          -DLLVM_BUILD_RUNTIME=OFF \
          -DLLVM_ENABLE_RUNTIMES="" \
          -DCOMPILER_RT_BUILD_SANITIZERS=OFF \
          -DCOMPILER_RT_BUILD_XRAY=OFF \
          -DCOMPILER_RT_BUILD_PROFILE=OFF \
          -DCOMPILER_RT_BUILD_MEMPROF=OFF \
          -DCOMPILER_RT_BUILD_ORC=OFF \
          \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_DOCS=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          \
          -DLLVM_ENABLE_TERMINFO=OFF \
          -DLLVM_ENABLE_ZLIB=ON

    - name: Build LLVM
      run: |
        cd build
        ninja -j$(nproc)

    - name: Verify OLLVM passes
      run: |
        echo "int test(int x){return x+1;}" > test.c
        build/bin/clang -O2 -mllvm -fla -c test.c -o test.o
        echo "âœ… OLLVM passes confirmed"

    - name: Package toolchain
      run: |
        mkdir -p android-ollvm/bin
        mkdir -p android-ollvm/lib

        cp build/bin/clang android-ollvm/bin/
        cp build/bin/clang++ android-ollvm/bin/
        cp build/bin/ld.lld android-ollvm/bin/
        cp build/bin/lld android-ollvm/bin/

        for t in llvm-ar llvm-nm llvm-strip llvm-objcopy llvm-objdump llvm-readelf llvm-ranlib; do
          cp build/bin/$t android-ollvm/bin/ || true
        done

        CLANG_VER=$(ls build/lib/clang | head -1)
        mkdir -p android-ollvm/lib/clang/$CLANG_VER
        cp -r build/lib/clang/$CLANG_VER/include android-ollvm/lib/clang/$CLANG_VER/

        tar -czf android-ollvm-aosp.tar.gz android-ollvm

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-aosp
        path: android-ollvm-aosp.tar.gz
        retention-days: 7
