name: Build Android OLLVM Compiler ARM64

on:
  workflow_dispatch:
    inputs:
      build_lld:
        description: 'Build LLD linker'
        type: boolean
        default: true  # Changed to true
      build_tools:
        description: 'Build LLVM tools (ar, nm, strip, objcopy, etc.)'
        type: boolean
        default: true
      strip_binaries:
        description: 'Strip binaries after build'
        type: boolean
        default: true
      strip_aggressively:
        description: 'Aggressive stripping'
        type: boolean
        default: false

jobs:
  build-android-ollvm:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        if git apply --check ../obfuscator.patch; then
          git apply --whitespace=nowarn ../obfuscator.patch
          echo "OLLVM patches applied"
        else
          git apply --whitespace=nowarn ../obfuscator.patch --reject || true
          echo "Patch applied with possible rejections"
        fi

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          libc6-dev-i386 \
          zlib1g-dev \
          binutils
        
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Build OLLVM for Android ARM64
      run: |
        mkdir -p build
        cd build
        
        echo "Building OLLVM for Android ARM64..."
        
        # CORRECT: Only valid project names
        LLVM_PROJECTS="clang"
        
        if ${{ github.event.inputs.build_lld }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;lld"
        fi
        
        echo "Projects: $LLVM_PROJECTS"
        
        # Build with tools enabled
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="$LLVM_PROJECTS" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-unknown-linux-android" \
          -DLLVM_ENABLE_LLD=${{ github.event.inputs.build_lld && 'ON' || 'OFF' }} \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=${{ github.event.inputs.build_tools && 'ON' || 'OFF' }} \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_ASM_COMPILER=clang \
          -G "Ninja"
        
        ninja -j$(nproc)
        
        echo "Build complete"
        echo "Available binaries:"
        ls -1 bin/ | head -20

    - name: Strip binaries
      if: ${{ github.event.inputs.strip_binaries }}
      run: |
        cd build/bin
        
        if ${{ github.event.inputs.strip_aggressively }}; then
          STRIP_FLAGS="--strip-all"
          echo "Aggressive stripping"
        else
          STRIP_FLAGS="--strip-debug"
          echo "Normal stripping"
        fi
        
        # Find all binaries to strip
        BINARIES=()
        for bin in *; do
          if [ -f "$bin" ] && [ -x "$bin" ] && file "$bin" | grep -q "ELF"; then
            BINARIES+=("$bin")
          fi
        done
        
        echo "Stripping ${#BINARIES[@]} binaries"
        
        TOTAL_SAVED=0
        for binary in "${BINARIES[@]}"; do
          original=$(stat -c%s "$binary")
          if strip $STRIP_FLAGS "$binary" 2>/dev/null; then
            stripped=$(stat -c%s "$binary")
            saved=$((original - stripped))
            TOTAL_SAVED=$((TOTAL_SAVED + saved))
            echo "  $binary: $((saved/1024))KB saved"
          fi
        done
        
        if [ $TOTAL_SAVED -gt 0 ]; then
          echo "Total saved: $((TOTAL_SAVED/1024/1024))MB"
        fi

    - name: Create package
      run: |
        mkdir -p android-ollvm-arm64/bin
        
        echo "Creating package..."
        
        # Copy compiler binaries
        cp -L build/bin/clang android-ollvm-arm64/bin/ 2>/dev/null || true
        cp -L build/bin/clang++ android-ollvm-arm64/bin/ 2>/dev/null || true
        
        # Copy LLD if built
        if ${{ github.event.inputs.build_lld }}; then
          [ -f "build/bin/lld" ] && cp -L build/bin/lld android-ollvm-arm64/bin/
          [ -f "build/bin/ld.lld" ] && cp -L build/bin/ld.lld android-ollvm-arm64/bin/
        fi
        
        # Copy LLVM tools if built
        if ${{ github.event.inputs.build_tools }}; then
          echo "Copying LLVM tools..."
          TOOLS=("llvm-ar" "llvm-nm" "llvm-strip" "llvm-objcopy" "llvm-objdump" "llvm-readelf" "llvm-ranlib")
          for tool in "${TOOLS[@]}"; do
            if [ -f "build/bin/$tool" ]; then
              cp -L "build/bin/$tool" "android-ollvm-arm64/bin/"
              echo "  $tool"
            fi
          done
        fi
        
        # Copy runtime
        if [ -d "build/lib/clang" ]; then
          CLANG_VER=$(ls build/lib/clang/ | head -1)
          mkdir -p android-ollvm-arm64/lib/clang/$CLANG_VER
          cp -r build/lib/clang/$CLANG_VER/include android-ollvm-arm64/lib/clang/$CLANG_VER/ 2>/dev/null || true
        fi
        
        tar -czf android-ollvm-arm64.tar.gz android-ollvm-arm64/
        
        echo "Package size: $(du -h android-ollvm-arm64.tar.gz | cut -f1)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-arm64-compiler
        path: android-ollvm-arm64.tar.gz
        retention-days: 7
