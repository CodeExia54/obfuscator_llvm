name: Build Android OLLVM Compiler ARM64

on:
  workflow_dispatch:
    inputs:
      build_lld:
        description: 'Build LLD linker'
        type: boolean
        default: false
      build_ar:
        description: 'Build llvm-ar archiver'
        type: boolean
        default: false
      build_nm:
        description: 'Build llvm-nm symbol lister'
        type: boolean
        default: false
      build_strip_tool:
        description: 'Build llvm-strip'
        type: boolean
        default: false
      build_objcopy:
        description: 'Build llvm-objcopy'
        type: boolean
        default: false
      build_objdump:
        description: 'Build llvm-objdump'
        type: boolean
        default: false
      build_readelf:
        description: 'Build llvm-readelf'
        type: boolean
        default: false
      build_ranlib:
        description: 'Build llvm-ranlib'
        type: boolean
        default: false
      strip_binaries:
        description: 'Strip binaries after build'
        type: boolean
        default: true
      strip_aggressively:
        description: 'Aggressive stripping'
        type: boolean
        default: false

jobs:
  build-android-ollvm:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        if git apply --check ../obfuscator.patch; then
          git apply --whitespace=nowarn ../obfuscator.patch
          echo "OLLVM patches applied"
        else
          git apply --whitespace=nowarn ../obfuscator.patch --reject || true
          echo "Patch applied with possible rejections"
        fi

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          libc6-dev-i386 \
          zlib1g-dev \
          binutils
        
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Build OLLVM for Android ARM64
      run: |
        mkdir -p build
        cd build
        
        echo "Building OLLVM for Android ARM64..."
        
        LLVM_PROJECTS="clang"
        
        if ${{ github.event.inputs.build_lld }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;lld"
        fi
        
        if ${{ github.event.inputs.build_ar }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-ar"
        fi
        
        if ${{ github.event.inputs.build_nm }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-nm"
        fi
        
        if ${{ github.event.inputs.build_strip_tool }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-strip"
        fi
        
        if ${{ github.event.inputs.build_objcopy }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-objcopy"
        fi
        
        if ${{ github.event.inputs.build_objdump }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-objdump"
        fi
        
        if ${{ github.event.inputs.build_readelf }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-readelf"
        fi
        
        if ${{ github.event.inputs.build_ranlib }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-ranlib"
        fi
        
        echo "Projects: $LLVM_PROJECTS"
        
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="$LLVM_PROJECTS" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-unknown-linux-android" \
          -DLLVM_ENABLE_LLD=ON \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_ASM_COMPILER=clang \
          -G "Ninja"
        
        ninja -j$(nproc)
        
        echo "Build complete"
        ls -1 bin/ | head -10

    - name: Strip binaries
      if: ${{ github.event.inputs.strip_binaries }}
      run: |
        cd build/bin
        
        if ${{ github.event.inputs.strip_aggressively }}; then
          STRIP_FLAGS="--strip-all"
          echo "Aggressive stripping"
        else
          STRIP_FLAGS="--strip-debug"
          echo "Normal stripping"
        fi
        
        BINARIES=("clang" "clang++")
        
        if ${{ github.event.inputs.build_lld }}; then
          BINARIES+=("lld" "ld.lld")
        fi
        
        if ${{ github.event.inputs.build_ar }}; then
          BINARIES+=("llvm-ar")
        fi
        
        if ${{ github.event.inputs.build_nm }}; then
          BINARIES+=("llvm-nm")
        fi
        
        if ${{ github.event.inputs.build_strip_tool }}; then
          BINARIES+=("llvm-strip")
        fi
        
        if ${{ github.event.inputs.build_objcopy }}; then
          BINARIES+=("llvm-objcopy")
        fi
        
        if ${{ github.event.inputs.build_objdump }}; then
          BINARIES+=("llvm-objdump")
        fi
        
        if ${{ github.event.inputs.build_readelf }}; then
          BINARIES+=("llvm-readelf")
        fi
        
        if ${{ github.event.inputs.build_ranlib }}; then
          BINARIES+=("llvm-ranlib")
        fi
        
        echo "Stripping ${#BINARIES[@]} binaries"
        
        TOTAL_SAVED=0
        for binary in "${BINARIES[@]}"; do
          if [ -f "$binary" ]; then
            original=$(stat -c%s "$binary")
            strip $STRIP_FLAGS "$binary" 2>/dev/null || continue
            stripped=$(stat -c%s "$binary")
            saved=$((original - stripped))
            TOTAL_SAVED=$((TOTAL_SAVED + saved))
            echo "  $binary: $((saved/1024))KB saved"
          fi
        done
        
        if [ $TOTAL_SAVED -gt 0 ]; then
          echo "Total saved: $((TOTAL_SAVED/1024/1024))MB"
        fi

    - name: Create package
      run: |
        mkdir -p android-ollvm-arm64/bin
        
        echo "Creating package..."
        
        cp -L build/bin/clang android-ollvm-arm64/bin/
        cp -L build/bin/clang++ android-ollvm-arm64/bin/
        
        if ${{ github.event.inputs.build_lld }}; then
          [ -f "build/bin/lld" ] && cp -L build/bin/lld android-ollvm-arm64/bin/
          [ -f "build/bin/ld.lld" ] && cp -L build/bin/ld.lld android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_ar }} && [ -f "build/bin/llvm-ar" ]; then
          cp -L build/bin/llvm-ar android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_nm }} && [ -f "build/bin/llvm-nm" ]; then
          cp -L build/bin/llvm-nm android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_strip_tool }} && [ -f "build/bin/llvm-strip" ]; then
          cp -L build/bin/llvm-strip android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_objcopy }} && [ -f "build/bin/llvm-objcopy" ]; then
          cp -L build/bin/llvm-objcopy android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_objdump }} && [ -f "build/bin/llvm-objdump" ]; then
          cp -L build/bin/llvm-objdump android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_readelf }} && [ -f "build/bin/llvm-readelf" ]; then
          cp -L build/bin/llvm-readelf android-ollvm-arm64/bin/
        fi
        
        if ${{ github.event.inputs.build_ranlib }} && [ -f "build/bin/llvm-ranlib" ]; then
          cp -L build/bin/llvm-ranlib android-ollvm-arm64/bin/
        fi
        
        if [ -d "build/lib/clang" ]; then
          CLANG_VER=$(ls build/lib/clang/ | head -1)
          mkdir -p android-ollvm-arm64/lib/clang/$CLANG_VER
          cp -r build/lib/clang/$CLANG_VER/include android-ollvm-arm64/lib/clang/$CLANG_VER/ 2>/dev/null || true
        fi
        
        tar -czf android-ollvm-arm64.tar.gz android-ollvm-arm64/
        
        echo "Package size: $(du -h android-ollvm-arm64.tar.gz | cut -f1)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-arm64-compiler
        path: android-ollvm-arm64.tar.gz
        retention-days: 7
