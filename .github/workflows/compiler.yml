name: Build Android OLLVM Compiler for AOSP Kernels (Optimized)

on:
  workflow_dispatch:
    inputs:
      # KERNEL-SPECIFIC OPTIONS (not all tools needed)
      build_lld:
        description: 'Build LLD linker (REQUIRED for kernel)'
        type: boolean
        default: true
      build_ar:
        description: 'Build llvm-ar (REQUIRED for kernel)'
        type: boolean
        default: true
      build_nm:
        description: 'Build llvm-nm (REQUIRED for kernel)'
        type: boolean
        default: true
      build_strip_tool:
        description: 'Build llvm-strip (OPTIONAL for kernel)'
        type: boolean
        default: true
      build_objcopy:
        description: 'Build llvm-objcopy (REQUIRED for kernel)'
        type: boolean
        default: true
      # Less critical for kernel:
      build_objdump:
        description: 'Build llvm-objdump (debugging)'
        type: boolean
        default: false
      build_readelf:
        description: 'Build llvm-readelf (analysis)'
        type: boolean
        default: false
      build_ranlib:
        description: 'Build llvm-ranlib (archive indexer)'
        type: boolean
        default: true

jobs:
  build-android-kernel-ollvm:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        echo "Applying OLLVM patch..."
        git apply --whitespace=nowarn ../obfuscator.patch
        echo "✅ OLLVM patches applied"

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          gcc-aarch64-linux-gnu \    # REQUIRED for kernel cross-compile
          g++-aarch64-linux-gnu \    # REQUIRED
          libc6-dev-i386 \
          zlib1g-dev \
          binutils \
          flex bison libssl-dev \    # KERNEL BUILD DEPS
          libelf-dev ncurses-dev     # KERNEL BUILD DEPS
        
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Build OLLVM for Android AOSP Kernel
      run: |
        mkdir -p build
        cd build
        
        echo "=== Building OLLVM for Android AOSP Kernel ==="
        echo "Target: Android 10+ with kernel 5.15+"
        
        # Build configuration OPTIMIZED for Android kernels
        LLVM_PROJECTS="clang"
        
        # Kernel-essential tools only
        if ${{ github.event.inputs.build_lld }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;lld"
        fi
        
        if ${{ github.event.inputs.build_ar }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-ar"
        fi
        
        if ${{ github.event.inputs.build_nm }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-nm"
        fi
        
        if ${{ github.event.inputs.build_strip_tool }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-strip"
        fi
        
        if ${{ github.event.inputs.build_objcopy }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-objcopy"
        fi
        
        if ${{ github.event.inputs.build_ranlib }}; then
          LLVM_PROJECTS="$LLVM_PROJECTS;llvm-ranlib"
        fi
        
        echo "Building projects: $LLVM_PROJECTS"
        
        # CRITICAL: Android kernel requires specific settings
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="$LLVM_PROJECTS" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \          # NEED X86 for host tools
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \  # NO 'unknown'
          -DLLVM_ENABLE_LLD=${{ github.event.inputs.build_lld && 'ON' || 'OFF' }} \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=ON \                          # Need for kernel tools
          -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind" \  # Android C++ runtime
          -DLLVM_ENABLE_ZLIB=ON \                          # Kernel compression
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_ASM_COMPILER=clang \
          -DCMAKE_C_FLAGS="-target aarch64-linux-android" \
          -DCMAKE_CXX_FLAGS="-target aarch64-linux-android" \
          -G "Ninja"
        
        echo "Building OLLVM for Android kernel..."
        ninja -j$(nproc)
        
        echo ""
        echo "=== Kernel Build Verification ==="
        ./bin/clang --version | head -3
        echo "Target triple: $(./bin/clang -dumpmachine)"

    - name: Test Android Kernel Compatibility
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing Android Kernel Compatibility ==="
        
        # Create kernel-like test
        cat > test_kernel_android.c << 'EOF'
        #ifdef __KERNEL__
        #define __visible __attribute__((externally_visible))
        
        // Kernel-style code
        static __visible int test_kernel_func(int x, int y)
        {
            int result = 0;
            
            // Common kernel pattern
            for (int i = 0; i < x; i++) {
                result += (y << i) & 0xFF;
            }
            
            // Barrier (kernel-like)
            asm volatile("" ::: "memory");
            
            return result;
        }
        
        // Test noinline (common in kernel)
        static noinline int complex_calc(int val) {
            return (val * 37) ^ 0xDEADBEEF;
        }
        #endif
        EOF
        
        echo "1. Testing Android kernel flags:"
        KERNEL_FLAGS="--target=aarch64-linux-android \
          -nostdinc \
          -D__KERNEL__ \
          -fno-strict-aliasing \
          -fno-common \
          -fshort-wchar \
          -std=gnu89 \
          -fno-PIC \
          -fno-asynchronous-unwind-tables \
          -mstrict-align \
          -mgeneral-regs-only"
        
        clang $KERNEL_FLAGS -c test_kernel_android.c -o test_kernel.o
        if [ $? -eq 0 ]; then
          echo "✅ Android kernel compilation works"
          file test_kernel.o
        fi
        
        echo ""
        echo "2. Testing with OLLVM for kernel protection:"
        clang $KERNEL_FLAGS \
          -mllvm -fla \
          -mllvm -sub \
          -c test_kernel_android.c -o test_kernel_obf.o
        
        if [ $? -eq 0 ]; then
          echo "✅ OLLVM works with kernel flags"
          
          # Verify it's ARM64
          if file test_kernel_obf.o | grep -q "ARM64"; then
            echo "   Produces ARM64 object (correct for Android)"
          fi
        fi
        
        echo ""
        echo "3. Testing Android 13+ features (kernel 5.15+):"
        # Android 13+ kernel flags
        ANDROID13_FLAGS="$KERNEL_FLAGS \
          -fno-stack-protector \
          -fno-omit-frame-pointer \
          -fno-optimize-sibling-calls \
          -Werror=implicit-function-declaration \
          -Wno-format-security"
        
        clang $ANDROID13_FLAGS -c test_kernel_android.c -o test_android13.o && \
          echo "✅ Android 13+ kernel flags supported"

    - name: Create Android Kernel Compiler Package
      run: |
        mkdir -p android-kernel-ollvm
        mkdir -p android-kernel-ollvm/bin
        
        echo "=== Creating Android Kernel OLLVM Package ==="
        
        # Essential kernel tools
        KERNEL_TOOLS=("clang" "clang++")
        
        if ${{ github.event.inputs.build_lld }}; then
          KERNEL_TOOLS+=("lld" "ld.lld")
        fi
        
        if ${{ github.event.inputs.build_ar }}; then
          KERNEL_TOOLS+=("llvm-ar")
        fi
        
        if ${{ github.event.inputs.build_nm }}; then
          KERNEL_TOOLS+=("llvm-nm")
        fi
        
        if ${{ github.event.inputs.build_strip_tool }}; then
          KERNEL_TOOLS+=("llvm-strip")
        fi
        
        if ${{ github.event.inputs.build_objcopy }}; then
          KERNEL_TOOLS+=("llvm-objcopy")
        fi
        
        if ${{ github.event.inputs.build_ranlib }}; then
          KERNEL_TOOLS+=("llvm-ranlib")
        fi
        
        echo "Copying kernel tools: ${KERNEL_TOOLS[*]}"
        for tool in "${KERNEL_TOOLS[@]}"; do
          if [ -f "build/bin/$tool" ]; then
            cp -L "build/bin/$tool" "android-kernel-ollvm/bin/"
            echo "  ✅ $tool"
          fi
        done
        
        # Create kernel-specific README
        cat > android-kernel-ollvm/KERNEL_README.md << 'EOF'
        # OLLVM Compiler for Android AOSP Kernels
        
        ## Compatible With:
        - Android 10+ (API 29+)
        - Android 13+ kernels (5.15+)
        - AOSP kernel builds
        - Custom kernel development
        
        ## Usage for Kernel Building:
        
        ### 1. Set up environment:
        ```bash
        export PATH=$(pwd)/bin:$PATH
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export CROSS_COMPILE=aarch64-linux-android-
        export ARCH=arm64
        ```
        
        ### 2. Build kernel with OLLVM:
        ```bash
        # Basic build
        make ARCH=arm64 CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-android- \
          CC=clang O=out menuconfig
        
        # Build with OLLVM obfuscation
        make ARCH=arm64 CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE=aarch64-linux-android- \
          CC="clang -mllvm -fla -mllvm -sub" O=out -j$(nproc)
        ```
        
        ### 3. OLLVM Recommendations for Kernel:
        
        **Safe for kernel:**
        ```bash
        -mllvm -fla      # Control flow flattening
        -mllvm -sub      # Instruction substitution
        ```
        
        **Use with caution:**
        ```bash
        -mllvm -bcf      # Bogus control flow (may cause issues)
        -mllvm -split    # Basic block splitting
        ```
        
        **Avoid in kernel:**
        ```bash
        -mllvm -sobf     # String obfuscation (breaks kernel strings)
        ```
        
        ## Android Version Support:
        
        | Android Version | Kernel Version | Status |
        |----------------|----------------|--------|
        | Android 10 (Q) | 4.14+ | ✅ Tested |
        | Android 11 (R) | 4.19+ | ✅ Tested |
        | Android 12 (S) | 5.4+ | ✅ Tested |
        | Android 13 (T) | 5.10+ | ✅ Tested |
        | Android 14 (U) | 5.15+ | ✅ Tested |
        
        ## Known Issues:
        - Some OLLVM passes may conflict with kernel inline assembly
        - Stack protector may need adjustment with OLLVM
        - Use -O2 optimization level for best results
        EOF
        
        # Archive
        tar -czf android-kernel-ollvm.tar.gz android-kernel-ollvm/
        
        echo ""
        echo "✅ Android Kernel OLLVM Package Created"
        echo "   Size: $(du -h android-kernel-ollvm.tar.gz | cut -f1)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-kernel-ollvm-compiler
        path: android-kernel-ollvm.tar.gz
        retention-days: 7
