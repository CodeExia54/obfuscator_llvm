name: Build OLLVM Clang for arm64

on:
  push:
    branches: [ main, release/14.x ]
  pull_request:
    branches: [ main, release/14.x ]
  workflow_dispatch:

env:
  OLLVM_VERSION: "14.0.0"
  BUILD_TYPE: Release
  TARGET_ARCH: "AArch64"
  
jobs:
  build-ollvm-clang:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: release/14.x

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        if [ -f "../obfuscator.patch" ]; then
          git apply ../obfuscator.patch
          echo "✅ Patch applied successfully"
        else
          echo "❌ obfuscator.patch not found"
          exit 1
        fi

    - name: Install essential dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y cmake
        sudo apt-get install -y ninja-build
        sudo apt-get install -y git
        sudo apt-get install -y python3
        sudo apt-get install -y zlib1g-dev

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -G "Ninja"
        echo "✅ CMake configuration complete"

    - name: Build clang
      run: |
        cd build
        ninja clang
        echo "✅ Clang build complete"

    - name: Test clang
      run: |
        export PATH=$PWD/build/bin:$PATH
        clang --version
        echo "int main() { return 0; }" > test.c
        clang -target aarch64-linux-android21 -c test.c -o test.o
        echo "✅ Clang test passed"

    - name: Create toolchain package
      run: |
        mkdir -p toolchain/bin
        cp build/bin/clang toolchain/bin/
        cp build/bin/clang++ toolchain/bin/
        tar -czf ollvm-clang-arm64.tar.gz toolchain/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ollvm-clang-arm64
        path: ollvm-clang-arm64.tar.gz
