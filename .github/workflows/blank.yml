name: Build OLLVM Clang for arm64

on:
  push:
    branches: [ main, release/14.x ]
  pull_request:
    branches: [ main, release/14.x ]
  workflow_dispatch:

env:
  OLLVM_VERSION: "14.0.0"
  
jobs:
  build-ollvm-clang:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: release/14.x

    - name: Apply patch
      run: |
        cd llvm-project
        git apply ../obfuscator.patch

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          zlib1g-dev \
          libxml2-dev \
          lld

    - name: Configure CMake (without LLD requirement)
      run: |
        mkdir -p build
        cd build
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_ENABLE_LLD=OFF \
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_LLVM_DYLIB=OFF \
          -G "Ninja"
        echo "CMake configuration complete"

    - name: Build clang
      run: |
        cd build
        ninja clang -j$(nproc)
        echo "Build complete"

    - name: Test clang
      run: |
        export PATH=$PWD/build/bin:$PATH
        clang --version
        echo "âœ… Clang is built successfully"

    - name: Package the toolchain
      run: |
        mkdir -p toolchain/bin
        mkdir -p toolchain/lib
        
        # Copy clang binaries
        cp build/bin/clang toolchain/bin/
        cp build/bin/clang++ toolchain/bin/
        
        # Create README
        cat > toolchain/README.md << 'EOF'
        OLLVM Clang for ARM64
        
        Built from: https://github.com/sr-tream/obfuscator (release/14.x)
        
        Usage:
        ./bin/clang -target aarch64-linux-android21 -mllvm -fla source.c
        
        OLLVM options:
        -mllvm -fla    : Control Flow Flattening
        -mllvm -sub    : Instruction Substitution
        -mllvm -bcf    : Bogus Control Flow
        -mllvm -sobf   : String Obfuscation
        EOF
        
        # Create archive
        tar -czf ollvm-clang-arm64.tar.gz toolchain/
        ls -lh ollvm-clang-arm64.tar.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ollvm-clang-arm64
        path: ollvm-clang-arm64.tar.gz
