name: Build OLLVM Clang for arm64

on:
  push:
    branches: [ main, release/14.x ]
  pull_request:
    branches: [ main, release/14.x ]
  workflow_dispatch:

env:
  OLLVM_VERSION: "14.0.0"
  BUILD_TYPE: Release
  TARGET_ARCH: "AArch64"
  
jobs:
  build-ollvm-clang:
    runs-on: ubuntu-22.04  # Ubuntu 22.04 LTS (Jammy)
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: release/14.x

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply ../obfuscator.patch
        echo "Patch applied successfully"

    - name: Install dependencies for Ubuntu 22.04
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          cmake-data \
          ninja-build \
          python3 \
          python3-pip \
          git \
          libncurses5-dev \  # Available in Ubuntu 22.04
          libncursesw5-dev \
          libxml2-dev \
          libedit-dev \
          libedit2 \
          swig \
          zlib1g-dev \
          zlib1g

    - name: Configure CMake for clang only (arm64)
      run: |
        mkdir -p build
        cd build
        cmake \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_ENABLE_BINDINGS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_INCLUDE_BENCHMARKS=OFF \
          -DLLVM_ENABLE_LLD=ON \
          -DLLVM_STATIC_LINK_CXX_STDLIB=ON \
          -DLLVM_TARGETS_TO_BUILD="$TARGET_ARCH" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \
          -S ../llvm-project/llvm \
          -B . \
          -G "Ninja"

    - name: Build clang
      run: |
        cd build
        ninja clang clang++ lld -j$(nproc)

    - name: Test the build
      run: |
        export PATH=$PWD/build/bin:$PATH
        clang --version
        echo "int main() { return 0; }" > test.c
        clang -target aarch64-linux-android21 test.c -c -o test.o && echo "âœ… Build works"

    - name: Create toolchain tarball
      run: |
        mkdir -p toolchain/bin
        cp build/bin/clang toolchain/bin/
        cp build/bin/clang++ toolchain/bin/
        cp build/bin/lld toolchain/bin/
        tar -czf ollvm-clang-arm64.tar.gz toolchain/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ollvm-clang-arm64
        path: ollvm-clang-arm64.tar.gz
