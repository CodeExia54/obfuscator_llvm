name: Build Android API 29 Cross-Compiler with FULL OLLVM Obfuscation

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-android-arm64-cross:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch
        echo "✅ OLLVM obfuscation patches applied"

    - name: Install build tools with LLD
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-yaml \
          python3-pip \
          lld \
          clang \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu
        
        # Install LLVM 14 toolchain
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 14
        sudo apt install -y clang-14 lld-14 llvm-14-tools
        
        # Set clang-14 as default
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 100
        sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-14 100

    - name: Setup Python
      run: |
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        export ANDROID_NDK=$PWD/android-ndk-r25c
        echo "ANDROID_NDK=$ANDROID_NDK" >> $GITHUB_ENV
        echo "NDK_HOME=$ANDROID_NDK" >> $GITHUB_ENV

    - name: Configure OLLVM for Android (Simplified Approach)
      run: |
        mkdir -p build
        cd build
        
        # SIMPLIFIED: Build OLLVM as a regular compiler first, then we'll make it target Android
        # The key insight: OLLVM itself runs on x86_64 Linux, but generates ARM64 Android code
        
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DOBFUSCATOR_BUILD=ON \
          -DLLVM_OBFUSCATOR_ENABLE=ON \
          -DCMAKE_C_COMPILER=/usr/bin/clang-14 \
          -DCMAKE_CXX_COMPILER=/usr/bin/clang++-14 \
          -DLLVM_ENABLE_LLD=ON \
          -DLLVM_USE_LINKER=lld \
          -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld" \
          -DCLANG_DEFAULT_LINKER="lld" \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=ON \
          -DLLVM_ENABLE_ASSERTIONS=ON \
          -G "Ninja"
        
        echo "✅ Configured OLLVM with Android ARM64 target support"

    - name: Build OLLVM compiler
      run: |
        cd build
        ninja clang lld -j$(nproc)
        echo "✅ Built OLLVM compiler"

    - name: Test OLLVM for Android compilation
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing OLLVM Android Compilation ==="
        
        # Create test program
        cat > test_android.c << 'EOF'
        #include <stdio.h>
        
        int main() {
            printf("Hello from Android!\n");
            return 0;
        }
        EOF
        
        # Test that clang can target Android
        echo "1. Checking Android target support:"
        clang --target=aarch64-linux-android29 -E - < /dev/null 2>&1 | grep -q "clang" && \
        echo "✅ Can target Android ARM64"
        
        # Test OLLVM passes
        echo ""
        echo "2. Testing OLLVM passes:"
        clang --target=aarch64-linux-android29 -mllvm -fla -c test_android.c -o test_fla.o 2>&1 | head -5
        if [ $? -eq 0 ]; then
            echo "✅ OLLVM passes work"
        fi
        
        # Show clang version and capabilities
        echo ""
        echo "3. Clang capabilities:"
        clang --version
        echo ""
        clang --target=aarch64-linux-android29 --print-effective-triple
        echo ""
        echo "Available targets:"
        clang --print-targets

    - name: Create Android-ready package
      run: |
        mkdir -p android-ollvm-dist
        mkdir -p android-ollvm-dist/bin
        
        # Copy binaries
        cp -L build/bin/clang android-ollvm-dist/bin/
        cp -L build/bin/clang++ android-ollvm-dist/bin/
        cp -L build/bin/ld.lld android-ollvm-dist/bin/ 2>/dev/null || true
        
        # Create Android usage wrapper
        cat > android-ollvm-dist/android-compile.sh << 'EOF'
        #!/bin/bash
        # Android OLLVM Compilation Wrapper
        
        # Default settings
        ANDROID_NDK="${ANDROID_NDK:-/path/to/android-ndk}"
        API_LEVEL="${API_LEVEL:-29}"
        TARGET_TRIPLE="aarch64-linux-android${API_LEVEL}"
        SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        
        # Get script directory
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export PATH="$SCRIPT_DIR/bin:$PATH"
        
        # Parse arguments
        OLLVM_FLAGS=""
        COMPILE_ARGS=()
        
        while [[ $# -gt 0 ]]; do
            case $1 in
                --api=*)
                    API_LEVEL="${1#*=}"
                    TARGET_TRIPLE="aarch64-linux-android${API_LEVEL}"
                    shift
                    ;;
                --api)
                    API_LEVEL="$2"
                    TARGET_TRIPLE="aarch64-linux-android${API_LEVEL}"
                    shift 2
                    ;;
                --fla)
                    OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -fla"
                    shift
                    ;;
                --sub)
                    OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sub"
                    shift
                    ;;
                --bcf)
                    OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -bcf"
                    shift
                    ;;
                --split)
                    OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -split"
                    shift
                    ;;
                --sobf)
                    OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -sobf"
                    shift
                    ;;
                --obfuscate-heavy)
                    OLLVM_FLAGS="$OLLVM_FLAGS -mllvm -fla -mllvm -sub -mllvm -bcf -mllvm -split -mllvm -sobf"
                    shift
                    ;;
                --sysroot=*)
                    SYSROOT="${1#*=}"
                    shift
                    ;;
                --sysroot)
                    SYSROOT="$2"
                    shift 2
                    ;;
                --ndk=*)
                    ANDROID_NDK="${1#*=}"
                    SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
                    shift
                    ;;
                --ndk)
                    ANDROID_NDK="$2"
                    SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
                    shift 2
                    ;;
                *)
                    COMPILE_ARGS+=("$1")
                    shift
                    ;;
            esac
        done
        
        # Build the final command
        CMD=(clang)
        CMD+=(--target="$TARGET_TRIPLE")
        
        if [ -d "$SYSROOT" ]; then
            CMD+=(--sysroot="$SYSROOT")
        fi
        
        if [ ! -z "$OLLVM_FLAGS" ]; then
            # Split OLLVM flags properly
            for flag in $OLLVM_FLAGS; do
                CMD+=("$flag")
            done
        fi
        
        # Add remaining arguments
        CMD+=("${COMPILE_ARGS[@]}")
        
        echo "Compiling for Android with:"
        echo "  Target: $TARGET_TRIPLE"
        echo "  Sysroot: $SYSROOT"
        echo "  OLLVM flags: $OLLVM_FLAGS"
        echo ""
        echo "Command: ${CMD[@]}"
        echo ""
        
        # Execute
        exec "${CMD[@]}"
        EOF
        
        chmod +x android-ollvm-dist/android-compile.sh
        
        # Create README
        cat > android-ollvm-dist/README.md << 'EOF'
        # OLLVM Compiler for Android ARM64
        
        This is an OLLVM-enabled Clang compiler that can generate Android ARM64 binaries.
        
        ## Prerequisites
        
        1. Install Android NDK:
           ```bash
           wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
           unzip android-ndk-r25c-linux.zip
           export ANDROID_NDK=$PWD/android-ndk-r25c
           ```
        
        2. Set up environment:
           ```bash
           export PATH=$PWD/bin:$PATH
           export ANDROID_NDK=/path/to/your/android-ndk
           ```
        
        ## Usage
        
        ### Method 1: Using the wrapper script (recommended)
        ```bash
        ./android-compile.sh --api=29 --fla --sub --sysroot=$ANDROID_NDK/sysroot app.c -o app
        ```
        
        ### Method 2: Direct clang usage
        ```bash
        clang --target=aarch64-linux-android29 \
          --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
          -mllvm -fla \
          -mllvm -sub \
          app.c -o app
        ```
        
        ## OLLVM Obfuscation Options
        
        | Flag | Description |
        |------|-------------|
        | `--fla` | Control Flow Flattening |
        | `--sub` | Instruction Substitution |
        | `--bcf` | Bogus Control Flow |
        | `--split` | Basic Block Splitting |
        | `--sobf` | String Obfuscation |
        | `--obfuscate-heavy` | All obfuscations combined |
        
        ## API Levels
        
        Change API level with `--api=<level>`:
        ```bash
        # API 21 (Android 5.0 - minimum for ARM64)
        ./android-compile.sh --api=21 ...
        
        # API 29 (Android 10)
        ./android-compile.sh --api=29 ...
        
        # API 33 (Android 13)
        ./android-compile.sh --api=33 ...
        ```
        
        ## Complete Example
        
        ```bash
        # Compile with heavy obfuscation for Android 10
        ./android-compile.sh \
          --api=29 \
          --obfuscate-heavy \
          --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
          -O2 \
          -fvisibility=hidden \
          your_app.c -o your_app
        ```
        EOF
        
        tar -czf android-ollvm-compiler.tar.gz android-ollvm-dist/
        echo "✅ Android OLLVM package created"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-compiler
        path: android-ollvm-compiler.tar.gz
