name: Build Android OLLVM Compiler 64

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-android-ollvm:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch
        echo "✅ OLLVM patches applied"

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          ninja-build \
          lld \
          clang \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu
        
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Build OLLVM according to repo
      run: |
        mkdir -p build
        cd build
        
        # SIMPLE build following repo instructions
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \
          -DLLVM_HOST_TRIPLE="x86_64-unknown-linux-gnu" \
          -DLLVM_ENABLE_LLD=ON \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=ON \
          -G "Ninja"
        
        echo "Building OLLVM Clang..."
        ninja clang lld -j$(nproc)
        
        # Verify build
        if [ -f "bin/clang" ]; then
          echo "✅ SUCCESS: Built Clang!"
          ./bin/clang --version
        else
          echo "❌ FAILED: Clang not built"
          exit 1
        fi

    - name: Test Android compilation
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing Android Compilation ==="
        
        # Simple test
        cat > test.c << 'EOF'
        int main() { return 0; }
        EOF
        
        # Test Android target
        echo "1. Testing Android ARM64 target:"
        clang --target=aarch64-linux-android -c test.c -o test.o
        
        if [ $? -eq 0 ]; then
          echo "✅ Can compile for Android ARM64"
          file test.o
        fi
        
        # Test OLLVM
        echo ""
        echo "2. Testing OLLVM passes:"
        echo "Testing -fla:"
        clang --target=aarch64-linux-android -mllvm -fla -c test.c -o test_fla.o 2>/dev/null && echo "✅ -fla works"
        
        echo "Testing -sub:"
        clang --target=aarch64-linux-android -mllvm -sub -c test.c -o test_sub.o 2>/dev/null && echo "✅ -sub works"
        
        echo "Testing -bcf:"
        clang --target=aarch64-linux-android -mllvm -bcf -c test.c -o test_bcf.o 2>/dev/null && echo "✅ -bcf works"
        
        echo "Testing multiple passes:"
        clang --target=aarch64-linux-android -mllvm -fla -mllvm -sub -c test.c -o test_multi.o 2>/dev/null && echo "✅ Multiple passes work"

    - name: Create Android compiler package
      run: |
        mkdir -p android-ollvm
        mkdir -p android-ollvm/bin
        
        # Copy built binaries
        cp -L build/bin/clang android-ollvm/bin/
        cp -L build/bin/clang++ android-ollvm/bin/
        cp -L build/bin/ld.lld android-ollvm/bin/ 2>/dev/null || true
        
        # Verify what we have
        echo "Files in package:"
        ls -la android-ollvm/bin/
        echo ""
        echo "Clang details:"
        file android-ollvm/bin/clang
        
        # Create usage instructions
        cat > android-ollvm/USAGE.md << 'EOF'
        # OLLVM Android Compiler
        
        This is Clang with OLLVM obfuscation for Android ARM64.
        
        ## Quick Start
        
        1. Download Android NDK:
           ```bash
           wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
           unzip android-ndk-r25c-linux.zip
           export ANDROID_NDK=$PWD/android-ndk-r25c
           ```
        
        2. Compile Android app:
           ```bash
           export PATH=/path/to/this/bin:$PATH
           
           clang --target=aarch64-linux-android29 \
             --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
             -mllvm -fla \
             -mllvm -sub \
             your_app.c -o your_app
           ```
        
        ## OLLVM Obfuscation Options
        
        Available flags:
        - `-mllvm -fla` : Control Flow Flattening
        - `-mllvm -sub` : Instruction Substitution  
        - `-mllvm -bcf` : Bogus Control Flow
        - `-mllvm -split` : Basic Block Splitting
        - `-mllvm -sobf` : String Obfuscation
        
        ## Test Compilation
        
        ```bash
        # Test the compiler works
        echo "int main(){return 0;}" > test.c
        clang --target=aarch64-linux-android -c test.c -o test.o
        
        if [ -f "test.o" ]; then
          echo "✅ Compiler works!"
          file test.o
        fi
        ```
        EOF
        
        # Create test script
        cat > android-ollvm/test_android.sh << 'EOF'
        #!/bin/bash
        echo "Testing OLLVM Android Compiler"
        echo "==============================="
        
        # Set path
        export PATH="$(dirname "$0")/bin:$PATH"
        
        # Create test file
        cat > test_android.c << 'TESTEOF'
        #include <stdio.h>
        
        int secret_function(int x) {
            return x * 1337;
        }
        
        int main() {
            printf("Result: %d\n", secret_function(10));
            return 0;
        }
        TESTEOF
        
        echo "1. Testing basic Android compilation:"
        clang --target=aarch64-linux-android -c test_android.c -o test_android.o
        
        if [ $? -eq 0 ]; then
            echo "✅ Basic compilation works"
            file test_android.o
        else
            echo "❌ Basic compilation failed"
        fi
        
        echo ""
        echo "2. Testing OLLVM obfuscation:"
        clang --target=aarch64-linux-android -mllvm -fla -c test_android.c -o test_ollvm.o
        
        if [ $? -eq 0 ]; then
            echo "✅ OLLVM obfuscation works"
            echo "   File created: test_ollvm.o"
        else
            echo "⚠️  OLLVM might need sysroot for full linking"
        fi
        
        # Cleanup
        rm -f test_android.c test_android.o test_ollvm.o
        
        echo ""
        echo "For full Android compilation, you need Android NDK sysroot:"
        echo "  clang --target=aarch64-linux-android29 \\"
        echo "    --sysroot=/path/to/android-ndk/sysroot \\"
        echo "    -mllvm -fla \\"
        echo "    your_app.c -o your_app"
        EOF
        
        chmod +x android-ollvm/test_android.sh
        
        tar -czf android-ollvm-compiler.tar.gz android-ollvm/
        echo "✅ Package created: $(du -h android-ollvm-compiler.tar.gz)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-compiler
        path: android-ollvm-compiler.tar.gz
