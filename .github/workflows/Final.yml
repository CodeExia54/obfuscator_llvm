name: Build Android API 29 Cross-Compiler with FULL OLLVM Obfuscation

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-android-arm64-cross:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch
        echo "✅ OLLVM obfuscation patches applied"

    - name: Install build tools with LLD
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-yaml \
          python3-pip \
          lld \
          clang \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu
        
        # Install LLVM 14 toolchain
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 14
        sudo apt install -y clang-14 lld-14 llvm-14-tools
        
        # Set clang-14 as default
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-14 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-14 100
        sudo update-alternatives --install /usr/bin/ld.lld ld.lld /usr/bin/ld.lld-14 100

    - name: Setup Python
      run: |
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Download Android NDK
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        export ANDROID_NDK=$PWD/android-ndk-r25c
        echo "ANDROID_NDK=$ANDROID_NDK" >> $GITHUB_ENV
        echo "NDK_HOME=$ANDROID_NDK" >> $GITHUB_ENV

    - name: Configure for Android API 29 with ALL OLLVM passes
      run: |
        mkdir -p build
        cd build
        
        SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        
        # Use clang-14 as host compiler
        export CC=/usr/bin/clang-14
        export CXX=/usr/bin/clang++-14
        
        # Create OLLVM configuration file
        cat > ollvm_config.cmake << 'EOF'
        # Enable ALL OLLVM obfuscation passes
        set(LLVM_OBFUSCATE_FLATTEN ON CACHE BOOL "Enable control flow flattening" FORCE)
        set(LLVM_OBFUSCATE_SUBSTITUTE ON CACHE BOOL "Enable instruction substitution" FORCE)
        set(LLVM_OBFUSCATE_BOGUSCF ON CACHE BOOL "Enable bogus control flow" FORCE)
        set(LLVM_OBFUSCATE_SPLIT ON CACHE BOOL "Enable basic block splitting" FORCE)
        set(LLVM_OBFUSCATE_STRING ON CACHE BOOL "Enable string obfuscation" FORCE)
        set(LLVM_OBFUSCATE_FUNCTIONS ON CACHE BOOL "Enable function annotations" FORCE)
        set(LLVM_OBFUSCATE_INDIRECT ON CACHE BOOL "Enable indirect branching" FORCE)
        EOF
        
        # FIXED: Correct CMake command without broken -C option
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          
          # OLLVM-specific configuration
          -DOBFUSCATOR_BUILD=ON \
          -DLLVM_OBFUSCATOR_ENABLE=ON \
          
          # Host compiler with LLD support
          -DCMAKE_C_COMPILER=/usr/bin/clang-14 \
          -DCMAKE_CXX_COMPILER=/usr/bin/clang++-14 \
          
          # LLD configuration
          -DLLVM_ENABLE_LLD=ON \
          -DLLVM_USE_LINKER=lld \
          -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fuse-ld=lld" \
          -DCMAKE_MODULE_LINKER_FLAGS="-fuse-ld=lld" \
          
          # Host config
          -DCMAKE_HOST_SYSTEM_NAME="Linux" \
          -DCMAKE_HOST_SYSTEM_PROCESSOR="x86_64" \
          -DLLVM_HOST_TRIPLE="x86_64-unknown-linux-gnu" \
          
          # Target config - ANDROID API 29
          -DCMAKE_SYSTEM_NAME="Android" \
          -DCMAKE_SYSTEM_PROCESSOR="aarch64" \
          -DCMAKE_SYSTEM_VERSION="29" \
          
          # Target triple for Android 10 API 29
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android29" \
          
          # Android sysroot and flags
          -DCMAKE_SYSROOT="$SYSROOT" \
          -DCMAKE_C_FLAGS="--target=aarch64-linux-android29 --sysroot=$SYSROOT" \
          -DCMAKE_CXX_FLAGS="--target=aarch64-linux-android29 --sysroot=$SYSROOT" \
          
          # Toolchain from Android NDK
          -DCMAKE_AR="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" \
          -DCMAKE_RANLIB="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib" \
          -DCMAKE_STRIP="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip" \
          
          # Clang defaults with OLLVM
          -DCLANG_DEFAULT_LINKER="lld" \
          
          # OLLVM build flags
          -DLLVM_OBFUSCATE_FLATTEN=ON \
          -DLLVM_OBFUSCATE_SUBSTITUTE=ON \
          -DLLVM_OBFUSCATE_BOGUSCF=ON \
          -DLLVM_OBFUSCATE_SPLIT=ON \
          -DLLVM_OBFUSCATE_STRING=ON \
          -DLLVM_OBFUSCATE_FUNCTIONS=ON \
          -DLLVM_OBFUSCATE_INDIRECT=ON \
          
          # Build settings
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=ON \
          -DLLVM_ENABLE_ASSERTIONS=ON \
          
          -G "Ninja"
        
        echo "✅ Configured for Android API 29 with ALL OLLVM obfuscations"

    - name: Build compiler with all OLLVM passes
      run: |
        cd build
        ninja clang lld -j$(nproc)
        echo "✅ Built clang with ALL OLLVM obfuscation passes"

    - name: Test ALL OLLVM obfuscation passes
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing ALL OLLVM Obfuscation Passes ==="
        
        # Create comprehensive test program
        cat > test_ollvm_full.c << 'EOF'
        #include <stdio.h>
        #include <string.h>
        
        const char* secret = "This is a secret string";
        
        int fibonacci(int n) {
            if (n <= 1) return n;
            return fibonacci(n-1) + fibonacci(n-2);
        }
        
        void process_data(int* data, int size) {
            for (int i = 0; i < size; i++) {
                data[i] = data[i] * 2 + 1;
            }
        }
        
        int main() {
            printf("Testing ALL OLLVM passes\n");
            printf("Secret: %s\n", secret);
            
            int result = fibonacci(10);
            printf("Fibonacci(10) = %d\n", result);
            
            int data[5] = {1, 2, 3, 4, 5};
            process_data(data, 5);
            
            for (int i = 0; i < 5; i++) {
                printf("Data[%d] = %d\n", i, data[i]);
            }
            
            return 0;
        }
        EOF
        
        echo "1. Testing Control Flow Flattening (-fla):"
        clang -target aarch64-linux-android29 \
          --sysroot="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot" \
          -mllvm -fla \
          -c test_ollvm_full.c -o test_fla.o && \
        echo "✅ Control Flow Flattening works"
        
        echo ""
        echo "2. Testing Instruction Substitution (-sub):"
        clang -target aarch64-linux-android29 \
          --sysroot="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot" \
          -mllvm -sub \
          -c test_ollvm_full.c -o test_sub.o && \
        echo "✅ Instruction Substitution works"
        
        echo ""
        echo "3. Testing Bogus Control Flow (-bcf):"
        clang -target aarch64-linux-android29 \
          --sysroot="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot" \
          -mllvm -bcf \
          -c test_ollvm_full.c -o test_bcf.o && \
        echo "✅ Bogus Control Flow works"
        
        echo ""
        echo "4. Testing Basic Block Splitting (-split):"
        clang -target aarch64-linux-android29 \
          --sysroot="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot" \
          -mllvm -split \
          -c test_ollvm_full.c -o test_split.o && \
        echo "✅ Basic Block Splitting works"
        
        echo ""
        echo "5. Testing String Obfuscation (-sobf):"
        clang -target aarch64-linux-android29 \
          --sysroot="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot" \
          -mllvm -sobf \
          -c test_ollvm_full.c -o test_sobf.o && \
        echo "✅ String Obfuscation works"
        
        echo ""
        echo "6. Testing ALL passes combined:"
        clang -target aarch64-linux-android29 \
          --sysroot="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot" \
          -mllvm -fla \
          -mllvm -sub \
          -mllvm -bcf \
          -mllvm -split \
          -mllvm -sobf \
          -c test_ollvm_full.c -o test_all.o && \
        echo "✅ ALL OLLVM passes work together!"

    - name: Create package with ALL OLLVM obfuscations
      run: |
        mkdir -p android-api29-full-ollvm
        mkdir -p android-api29-full-ollvm/bin
        
        # Copy essential binaries
        cp -L build/bin/clang android-api29-full-ollvm/bin/
        cp -L build/bin/clang++ android-api29-full-ollvm/bin/
        cp -L build/bin/ld.lld android-api29-full-ollvm/bin/ 2>/dev/null || true
        
        # Create OLLVM presets file
        cat > android-api29-full-ollvm/ollvm_presets.sh << 'EOF'
        #!/bin/bash
        # OLLVM Obfuscation Presets for Android API 29
        
        export ANDROID_NDK="${ANDROID_NDK:-/path/to/android-ndk}"
        export SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        export PATH="$(dirname "$0")/bin:$PATH"
        
        # Light obfuscation (good balance)
        OLLVM_LIGHT="-mllvm -fla -mllvm -sub"
        
        # Medium obfuscation (more protection)
        OLLVM_MEDIUM="-mllvm -fla -mllvm -sub -mllvm -bcf"
        
        # Heavy obfuscation (maximum protection)
        OLLVM_HEAVY="-mllvm -fla -mllvm -sub -mllvm -bcf -mllvm -split -mllvm -sobf"
        
        # Compile with preset
        ollvm_compile() {
            local preset="$1"
            local api="${2:-29}"
            local infile="$3"
            local outfile="$4"
            shift 4
            
            case $preset in
                light) local flags="$OLLVM_LIGHT" ;;
                medium) local flags="$OLLVM_MEDIUM" ;;
                heavy) local flags="$OLLVM_HEAVY" ;;
                *) local flags="$preset" ;;
            esac
            
            clang -target "aarch64-linux-android$api" \
              --sysroot="$SYSROOT" \
              $flags \
              "$@" \
              "$infile" -o "$outfile"
        }
        
        echo "OLLVM Android API 29 compiler ready!"
        echo "Usage: ollvm_compile <light|medium|heavy> <api> <input> <output> [extra_flags]"
        EOF
        
        chmod +x android-api29-full-ollvm/ollvm_presets.sh
        
        # Create README
        cat > android-api29-full-ollvm/README.md << 'EOF'
        # Android API 29 OLLVM Compiler
        
        Complete OLLVM obfuscation compiler for Android 10 (API 29) ARM64.
        
        ## Available OLLVM Passes:
        - Control Flow Flattening (-mllvm -fla)
        - Instruction Substitution (-mllvm -sub)
        - Bogus Control Flow (-mllvm -bcf)
        - Basic Block Splitting (-mllvm -split)
        - String Obfuscation (-mllvm -sobf)
        
        ## Quick Start:
        ```bash
        # Set Android NDK path
        export ANDROID_NDK=/path/to/android-ndk
        
        # Load presets
        source ollvm_presets.sh
        
        # Compile with obfuscation
        ollvm_compile heavy 29 app.c app
        ```
        
        ## Manual Usage:
        ```bash
        ./bin/clang -target aarch64-linux-android29 \
          --sysroot=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
          -mllvm -fla \
          -mllvm -sub \
          app.c -o app
        ```
        EOF
        
        tar -czf android-api29-full-ollvm.tar.gz android-api29-full-ollvm/
        echo "✅ Complete OLLVM package created"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-api29-full-ollvm
        path: android-api29-full-ollvm.tar.gz
