name: Build OLLVM Clang for ARM64

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-arm64-clang:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch
        echo "✅ OLLVM patch applied"

    - name: Install tools (WITH LLD)
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build git lld
        echo "✅ Tools installed with LLD"

    - name: Configure for ARM64
      run: |
        mkdir -p build
        cd build
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-unknown-linux-gnu" \
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_INCLUDE_TESTS=OFF \
          -G "Ninja"
        echo "✅ Configured for ARM64"

    - name: Build clang
      run: |
        cd build
        ninja clang -j$(nproc)
        echo "✅ ARM64 clang built"

    - name: Verify ARM64 target support
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Verification ==="
        echo "1. Clang binary:"
        file -L build/bin/clang
        echo ""
        
        echo "2. Default target:"
        clang -print-target-triple
        echo ""
        
        echo "3. Test ARM64 compilation:"
        cat > test.c << 'EOF'
        int multiply(int a, int b) {
            return a * b;
        }
        EOF
        
        clang -target aarch64-unknown-linux-gnu -c test.c -o test.o
        if [ $? -eq 0 ]; then
          echo "✅ Can compile for ARM64"
          file test.o
        fi

    - name: Test OLLVM on ARM64
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== OLLVM Test ==="
        cat > test_ollvm.c << 'EOF'
        int secret(int x) {
            int r = 0;
            for (int i = 0; i < x; i++) {
                r += i * 3;
            }
            return r;
        }
        EOF
        
        echo "Testing OLLVM flags:"
        echo "- Control Flow Flattening:"
        clang -target aarch64-unknown-linux-gnu -mllvm -fla -c test_ollvm.c -o test_fla.o && \
        echo "✅ -fla works"
        
        echo ""
        echo "- Instruction Substitution:"
        clang -target aarch64-unknown-linux-gnu -mllvm -sub -c test_ollvm.c -o test_sub.o && \
        echo "✅ -sub works"
        
        echo ""
        echo "- All OLLVM features:"
        clang -target aarch64-unknown-linux-gnu \
          -mllvm -fla \
          -mllvm -sub \
          -mllvm -bcf \
          -c test_ollvm.c -o test_all.o && \
        echo "✅ All OLLVM features work on ARM64"

    - name: Package
      run: |
        mkdir -p clang-arm64-ollvm/bin
        cp -L build/bin/clang clang-arm64-ollvm/bin/
        cp -L build/bin/clang++ clang-arm64-ollvm/bin/
        
        # Simple README
        cat > clang-arm64-ollvm/README.md << 'EOF'
        # OLLVM Clang for ARM64
        
        Compiler with OLLVM obfuscation for ARM64 target.
        
        Usage:
        ./bin/clang -target aarch64-unknown-linux-gnu source.c
        
        OLLVM options:
        -mllvm -fla    # Control Flow Flattening
        -mllvm -sub    # Instruction Substitution
        -mllvm -bcf    # Bogus Control Flow
        -mllvm -sobf   # String Obfuscation
        EOF
        
        tar -czf clang-arm64-ollvm.tar.gz clang-arm64-ollvm/
        echo "✅ Package created"

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: clang-arm64-ollvm
        path: clang-arm64-ollvm.tar.gz
