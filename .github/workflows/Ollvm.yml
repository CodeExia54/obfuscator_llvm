name: Build Android OLLVM Compiler ARM64

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-android-ollvm:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        echo "Applying OLLVM patch..."
        if git apply --check ../obfuscator.patch; then
          git apply --whitespace=nowarn ../obfuscator.patch
          echo "âœ… OLLVM patches applied"
        else
          echo "âš ï¸ Patch doesn't apply cleanly, trying with rejections..."
          git apply --whitespace=nowarn ../obfuscator.patch --reject || true
          echo "Applied with possible rejections"
        fi

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          python3-pip \
          clang \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          libc6-dev-i386 \
          zlib1g-dev
        
        pip3 install pygments pyyaml
        sudo ln -s /usr/bin/python3 /usr/bin/python 2>/dev/null || true

    - name: Build OLLVM for Android ARM64
      run: |
        mkdir -p build
        cd build
        
        echo "=== Building OLLVM for Android ARM64 ==="
        echo "Using host compiler: $(clang --version | head -1)"
        
        # FIXED: Removed LLVM_USE_LINKER which conflicts with LLVM_ENABLE_LLD
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang;lld" \
          -DLLVM_TARGETS_TO_BUILD="AArch64;X86" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-unknown-linux-android" \
          -DLLVM_ENABLE_LLD=ON \
          -DLLVM_ENABLE_ASSERTIONS=OFF \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_ASM_COMPILER=clang \
          -G "Ninja"
        
        echo "Building OLLVM..."
        ninja -j$(nproc)
        
        # Verify build
        echo ""
        echo "=== Build Verification ==="
        if [ -f "bin/clang" ]; then
          echo "âœ… Clang built successfully"
          ./bin/clang --version | head -5
        else
          echo "âŒ Clang not found!"
          exit 1
        fi
        
        if [ -f "bin/lld" ] || [ -f "bin/ld.lld" ]; then
          echo "âœ… LLD built successfully"
        else
          echo "âš ï¸ LLD not found - checking for alternatives"
          ls -la bin/ld* 2>/dev/null || true
        fi
        
        # Check for OLLVM passes in opt
        if [ -f "bin/opt" ]; then
          echo ""
          echo "Checking OLLVM passes in opt..."
          ./bin/opt --help 2>&1 | grep -i "fla\|sub\|bcf\|split\|sobf" || echo "OLLVM passes not listed in opt help (normal)"
        fi

    - name: Test OLLVM functionality
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing OLLVM Functionality ==="
        
        # Create test file
        cat > test_ollvm.c << 'EOF'
        int test_function(int x) {
            if (x > 100) {
                return x * 2;
            } else {
                return x + 50;
            }
        }
        
        int main() {
            return test_function(42);
        }
        EOF
        
        echo "1. Testing basic compilation:"
        clang --target=aarch64-linux-android -c test_ollvm.c -o test_basic.o
        if [ $? -eq 0 ]; then
          echo "âœ… Basic compilation works"
          file test_basic.o
        fi
        
        echo ""
        echo "2. Testing OLLVM passes:"
        
        # Test each OLLVM pass
        declare -A passes
        passes=(
          ["-mllvm -fla"]="Control Flow Flattening"
          ["-mllvm -sub"]="Instruction Substitution"
          ["-mllvm -bcf"]="Bogus Control Flow"
          ["-mllvm -split"]="Basic Block Splitting"
          ["-mllvm -sobf"]="String Obfuscation"
        )
        
        for flag in "${!passes[@]}"; do
          echo "  Testing ${passes[$flag]}:"
          clang --target=aarch64-linux-android $flag -c test_ollvm.c -o "test_${passes[$flag]// /_}.o" 2>&1 | grep -v "warning:" || true
          
          if [ $? -eq 0 ]; then
            echo "    âœ… ${passes[$flag]} flag accepted"
          else
            echo "    âš ï¸  ${passes[$flag]} flag might not be available"
          fi
        done
        
        echo ""
        echo "3. Testing combined obfuscation:"
        clang --target=aarch64-linux-android \
          -mllvm -fla \
          -mllvm -sub \
          -mllvm -bcf \
          -c test_ollvm.c -o test_combined.o
        
        if [ $? -eq 0 ]; then
          echo "âœ… Combined OLLVM passes work"
          
          # Compare sizes
          BASIC_SIZE=$(stat -c%s test_basic.o 2>/dev/null || echo 0)
          COMBINED_SIZE=$(stat -c%s test_combined.o 2>/dev/null || echo 0)
          
          if [ $COMBINED_SIZE -gt $BASIC_SIZE ]; then
            echo "   Obfuscated code is larger (expected):"
            echo "   Basic: $BASIC_SIZE bytes"
            echo "   Obfuscated: $COMBINED_SIZE bytes"
            echo "   Increase: $((COMBINED_SIZE - BASIC_SIZE)) bytes"
          fi
        fi
        
        echo ""
        echo "4. Testing with LLVM IR output:"
        clang --target=aarch64-linux-android -S -emit-llvm test_ollvm.c -o test.ll
        if [ -f "test.ll" ]; then
          echo "âœ… Can generate LLVM IR"
          
          # Try to use opt with OLLVM passes
          if [ -f "build/bin/opt" ]; then
            echo "  Testing opt with OLLVM passes:"
            build/bin/opt -fla test.ll -S -o test_fla.ll 2>&1 | grep -i "error" || echo "    âœ… opt -fla works"
            build/bin/opt -sub test.ll -S -o test_sub.ll 2>&1 | grep -i "error" || echo "    âœ… opt -sub works"
          fi
        fi

    - name: Create standalone compiler package
      run: |
        mkdir -p android-ollvm-arm64
        mkdir -p android-ollvm-arm64/bin
        mkdir -p android-ollvm-arm64/lib
        
        echo "=== Creating Android OLLVM ARM64 Package ==="
        
        # Copy essential binaries
        echo "Copying binaries..."
        ESSENTIAL_BINARIES=("clang" "clang++" "lld" "ld.lld" "llvm-ar" "llvm-ranlib" "llvm-nm" "llvm-objcopy" "llvm-objdump" "llvm-readelf" "llvm-strip")
        
        for bin in "${ESSENTIAL_BINARIES[@]}"; do
          if [ -f "build/bin/$bin" ]; then
            cp -L "build/bin/$bin" android-ollvm-arm64/bin/
            echo "  âœ… $bin"
          fi
        done
        
        # Copy Clang runtime if available
        if [ -d "build/lib/clang" ]; then
          CLANG_VER=$(ls build/lib/clang/ | head -1)
          echo "Found Clang version: $CLANG_VER"
          mkdir -p android-ollvm-arm64/lib/clang/$CLANG_VER
          cp -r build/lib/clang/$CLANG_VER/include android-ollvm-arm64/lib/clang/$CLANG_VER/ 2>/dev/null || true
        fi
        
        # Verify package
        echo ""
        echo "Package contents:"
        ls -la android-ollvm-arm64/bin/
        echo ""
        echo "Compiler info:"
        android-ollvm-arm64/bin/clang --version | head -5
        
        # Create setup script
        cat > android-ollvm-arm64/setup.sh << 'EOF'
        #!/bin/bash
        echo "OLLVM Android ARM64 Compiler Setup"
        echo "==================================="
        
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        
        # Add to PATH
        export PATH="$SCRIPT_DIR/bin:$PATH"
        export CC="$SCRIPT_DIR/bin/clang"
        export CXX="$SCRIPT_DIR/bin/clang++"
        export LD="$SCRIPT_DIR/bin/lld"
        
        echo "Environment set up:"
        echo "  CC=$CC"
        echo "  CXX=$CXX"
        echo "  LD=$LD"
        echo "  PATH updated"
        
        echo ""
        echo "Test compilation:"
        echo "  clang --target=aarch64-linux-android -mllvm -fla test.c -o test"
        EOF
        
        chmod +x android-ollvm-arm64/setup.sh
        
        # Create test script
        cat > android-ollvm-arm64/test_compiler.sh << 'EOF'
        #!/bin/bash
        echo "Testing OLLVM Android ARM64 Compiler"
        echo "===================================="
        
        export PATH="$(dirname "$0")/bin:$PATH"
        
        # Create test file
        cat > test.c << 'TESTEOF'
        #include <stdio.h>
        
        int secret(int x) {
            int result = 0;
            for (int i = 0; i < x; i++) {
                result += i * i;
            }
            return result;
        }
        
        int main() {
            printf("Secret: %d\n", secret(5));
            return 0;
        }
        TESTEOF
        
        echo "1. Basic Android ARM64 compilation:"
        clang --target=aarch64-linux-android -c test.c -o test.o
        if [ $? -eq 0 ]; then
            echo "âœ… Success"
            file test.o
        else
            echo "âŒ Failed"
        fi
        
        echo ""
        echo "2. OLLVM obfuscation test:"
        clang --target=aarch64-linux-android -mllvm -fla -mllvm -sub -c test.c -o test_obf.o
        if [ $? -eq 0 ]; then
            echo "âœ… OLLVM flags accepted"
            
            # Compare sizes
            if [ -f "test.o" ] && [ -f "test_obf.o" ]; then
                SIZE1=$(stat -c%s test.o)
                SIZE2=$(stat -c%s test_obf.o)
                echo "   Basic size: $SIZE1 bytes"
                echo "   Obfuscated size: $SIZE2 bytes"
                if [ $SIZE2 -gt $SIZE1 ]; then
                    echo "   âœ… Obfuscation increased size (expected)"
                fi
            fi
        else
            echo "âŒ OLLVM flags rejected"
        fi
        
        echo ""
        echo "3. Linker test:"
        if command -v lld >/dev/null 2>&1; then
            echo "âœ… LLD available"
        else
            echo "âš ï¸ LLD not found in PATH"
        fi
        
        # Cleanup
        rm -f test.c test.o test_obf.o
        
        echo ""
        echo "===================================="
        echo "Compiler appears to be working correctly!"
        EOF
        
        chmod +x android-ollvm-arm64/test_compiler.sh
        
        # Create README
        cat > android-ollvm-arm64/README.md << 'EOF'
        # OLLVM Android ARM64 Compiler
        
        ## Quick Start
        
        1. Extract package:
           ```bash
           tar -xzf android-ollvm-arm64.tar.gz
           cd android-ollvm-arm64
           ```
        
        2. Setup environment:
           ```bash
           source setup.sh
           ```
        
        3. Test compiler:
           ```bash
           ./test_compiler.sh
           ```
        
        ## Usage
        
        ### Basic compilation:
        ```bash
        clang --target=aarch64-linux-android your_file.c -o your_file
        ```
        
        ### With OLLVM obfuscation:
        ```bash
        # Single pass
        clang --target=aarch64-linux-android -mllvm -fla your_file.c
        
        # Multiple passes
        clang --target=aarch64-linux-android \
          -mllvm -fla \
          -mllvm -sub \
          -mllvm -bcf \
          your_file.c -o obfuscated_binary
        ```
        
        ### With Android NDK sysroot:
        ```bash
        clang --target=aarch64-linux-android29 \
          --sysroot=/path/to/android-ndk/sysroot \
          -mllvm -fla \
          -mllvm -sub \
          your_app.c -o your_app
        ```
        
        ## Available OLLVM Passes
        
        Pass via `-mllvm` flag:
        
        | Flag | Description |
        |------|-------------|
        | `-mllvm -fla` | Control Flow Flattening |
        | `-mllvm -sub` | Instruction Substitution |
        | `-mllvm -bcf` | Bogus Control Flow |
        | `-mllvm -split` | Basic Block Splitting |
        | `-mllvm -sobf` | String Obfuscation |
        
        ## Advanced Options
        
        Some passes support parameters:
        ```bash
        # Apply substitution 3 times
        -mllvm -sub -mllvm -sub_loop=3
        
        # Bogus control flow with 50% probability
        -mllvm -bcf -mllvm -bcf_prob=50
        ```
        
        ## Directory Structure
        
        ```
        android-ollvm-arm64/
        â”œâ”€â”€ bin/           # Compiler tools (clang, clang++, lld, etc.)
        â”œâ”€â”€ lib/           # Runtime libraries
        â”œâ”€â”€ setup.sh       # Environment setup
        â”œâ”€â”€ test_compiler.sh # Test script
        â””â”€â”€ README.md      # This file
        ```
        EOF
        
        # Create archive
        tar -czf android-ollvm-arm64.tar.gz android-ollvm-arm64/
        
        echo ""
        echo "âœ… Package created: android-ollvm-arm64.tar.gz"
        echo "   Size: $(du -h android-ollvm-arm64.tar.gz | cut -f1)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-ollvm-arm64-compiler
        path: android-ollvm-arm64.tar.gz
        retention-days: 7

    - name: Display usage instructions
      run: |
        echo "=========================================="
        echo "ðŸš€ OLLVM Android ARM64 Compiler Built Successfully!"
        echo "=========================================="
        echo ""
        echo "ðŸ“¦ Download the artifact: android-ollvm-arm64-compiler"
        echo ""
        echo "ðŸ”§ To use the compiler:"
        echo "   1. Extract: tar -xzf android-ollvm-arm64.tar.gz"
        echo "   2. Setup: cd android-ollvm-arm64 && source setup.sh"
        echo "   3. Test: ./test_compiler.sh"
        echo ""
        echo "âš™ï¸  OLLVM usage examples:"
        echo "   clang --target=aarch64-linux-android -mllvm -fla app.c"
        echo "   clang --target=aarch64-linux-android -mllvm -fla -mllvm -sub app.c"
        echo "   clang --target=aarch64-linux-android -mllvm -fla -mllvm -sub -mllvm -bcf app.c"
        echo ""
        echo "ðŸ“š For Android development, download NDK and use --sysroot"
        echo "   clang --target=aarch64-linux-android29 \\"
        echo "     --sysroot=/path/to/ndk/sysroot \\"
        echo "     -mllvm -fla \\"
        echo "     your_app.c -o your_app"
