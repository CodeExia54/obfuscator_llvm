name: Build Android ARM64 Cross-Compiler with OLLVM

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-android-arm64-cross:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply --whitespace=nowarn ../obfuscator.patch
        echo "✅ OLLVM obfuscation patches applied"

    - name: Download Android NDK for headers and sysroot
      run: |
        wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
        unzip -q android-ndk-r25c-linux.zip
        export ANDROID_NDK=$PWD/android-ndk-r25c
        echo "ANDROID_NDK=$ANDROID_NDK" >> $GITHUB_ENV
        echo "✅ Android NDK downloaded"

    - name: Install build tools
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          lld

    - name: Configure Android ARM64 cross-compiler WITH SYSROOT
      run: |
        mkdir -p build
        cd build
        
        # Get Android sysroot path
        SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        echo "Using Android sysroot: $SYSROOT"
        
        # Configure as PROPER Android cross-compiler
        cmake ../llvm-project/llvm \
          -DCMAKE_BUILD_TYPE=Release \
          -DLLVM_ENABLE_PROJECTS="clang" \
          
          # HOST: x86_64 Linux
          -DCMAKE_HOST_SYSTEM_PROCESSOR="x86_64" \
          -DLLVM_HOST_TRIPLE="x86_64-unknown-linux-gnu" \
          
          # TARGET: Android ARM64
          -DLLVM_TARGETS_TO_BUILD="AArch64" \
          -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" \
          
          # Android sysroot configuration (CRITICAL!)
          -DCMAKE_SYSROOT="$SYSROOT" \
          -DCMAKE_C_FLAGS="--target=aarch64-linux-android21 --sysroot=$SYSROOT" \
          -DCMAKE_CXX_FLAGS="--target=aarch64-linux-android21 --sysroot=$SYSROOT" \
          
          # Cross-compilation settings
          -DCMAKE_SYSTEM_NAME="Android" \
          -DCMAKE_SYSTEM_PROCESSOR="aarch64" \
          -DCMAKE_SYSTEM_VERSION="21" \
          
          # Minimal build
          -DLLVM_ENABLE_RUNTIMES="" \
          -DLLVM_INCLUDE_TESTS=OFF \
          -DLLVM_INCLUDE_EXAMPLES=OFF \
          -DLLVM_BUILD_TOOLS=OFF \
          -DLLVM_ENABLE_LLD=ON \
          
          -G "Ninja"
        
        echo "✅ Configured: x86_64 → Android ARM64 with proper sysroot"

    - name: Build clang cross-compiler
      run: |
        cd build
        ninja clang -j$(nproc)
        echo "✅ Android ARM64 cross-compiler built"

    - name: Verify cross-compiler
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Verifying Cross-Compiler ==="
        echo "1. Clang binary:"
        file -L build/bin/clang
        
        echo ""
        echo "2. Default target:"
        ./build/bin/clang -print-target-triple
        
        echo ""
        echo "3. Available targets:"
        ./build/bin/clang -target help 2>&1 | grep -i "aarch64\|android" || true

    - name: Test Android ARM64 compilation WITH ANDROID HEADERS
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing Android ARM64 with proper headers ==="
        
        # Get Android sysroot
        SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        
        # Create test with stdio.h (Android version)
        cat > test_android.c << 'EOF'
        #include <stdio.h>
        
        int calculate(int a, int b) {
            return a * b + 42;
        }
        
        int main() {
            printf("Hello Android ARM64!\n");
            return calculate(5, 3);
        }
        EOF
        
        echo "1. Compile with Android sysroot:"
        clang -target aarch64-linux-android21 \
          --sysroot="$SYSROOT" \
          -c test_android.c -o test_android.o
        
        if [ $? -eq 0 ] && [ -f "test_android.o" ]; then
          echo "✅ SUCCESS: Can compile with Android headers!"
          echo "Output: $(file test_android.o)"
          
          if file test_android.o | grep -q "ARM aarch64"; then
            echo "✅ CONFIRMED: Produces ARM64 Android binaries"
          fi
        else
          echo "❌ FAILED with Android headers"
          echo "Trying simple test without headers..."
          
          # Simple test
          cat > test_simple.c << 'SIMPLE'
          int test() { return 42; }
          SIMPLE
          
          clang -target aarch64-linux-android21 -c test_simple.c -o test_simple.o
          if [ $? -eq 0 ]; then
            echo "⚠️  Can compile simple code, but Android headers issue"
            file test_simple.o
          fi
          exit 1
        fi
        
        echo ""
        echo "2. Test OLLVM obfuscation with Android headers:"
        clang -target aarch64-linux-android21 \
          --sysroot="$SYSROOT" \
          -mllvm -fla \
          -c test_android.c -o test_ollvm.o
        
        if [ $? -eq 0 ]; then
          echo "✅ OLLVM works with Android headers!"
          
          # Compare sizes
          if [ -f "test_android.o" ] && [ -f "test_ollvm.o" ]; then
            NORMAL_SIZE=$(stat -c%s test_android.o)
            OLLVM_SIZE=$(stat -c%s test_ollvm.o)
            
            if [ $OLLVM_SIZE -gt $NORMAL_SIZE ]; then
              INCREASE=$(( (OLLVM_SIZE * 100) / NORMAL_SIZE - 100 ))
              echo "✅ OLLVM increases size by $INCREASE%"
            fi
          fi
        fi

    - name: Create cross-compiler package WITH ANDROID CONFIG
      run: |
        mkdir -p android-arm64-ollvm-cc
        mkdir -p android-arm64-ollvm-cc/bin
        mkdir -p android-arm64-ollvm-cc/config
        
        # Copy the cross-compiler
        cp -L build/bin/clang android-arm64-ollvm-cc/bin/
        cp -L build/bin/clang++ android-arm64-ollvm-cc/bin/
        
        # Save Android NDK path info
        SYSROOT="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
        cat > android-arm64-ollvm-cc/config/android_paths.cfg << EOF
        # Android configuration for OLLVM cross-compiler
        ANDROID_SYSROOT=$SYSROOT
        ANDROID_TARGET=aarch64-linux-android21
        EOF
        
        # Create Android wrapper script
        cat > android-arm64-ollvm-cc/bin/android-clang << 'EOF'
        #!/bin/bash
        # Wrapper for Android compilation with OLLVM
        
        # Default Android paths (user should override if needed)
        ANDROID_SYSROOT="${ANDROID_SYSROOT:-/path/to/android-ndk/sysroot}"
        TARGET="${ANDROID_TARGET:-aarch64-linux-android21}"
        
        # Find the actual clang binary
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        CLANG_BIN="$SCRIPT_DIR/clang"
        
        # Build command with Android sysroot
        exec "$CLANG_BIN" --target="$TARGET" --sysroot="$ANDROID_SYSROOT" "$@"
        EOF
        
        chmod +x android-arm64-ollvm-cc/bin/android-clang
        
        # Create verification script
        cat > android-arm64-ollvm-cc/verify.sh << 'EOF'
        #!/bin/bash
        echo "=== Android ARM64 OLLVM Cross-Compiler Verification ==="
        echo ""
        
        echo "1. Basic check:"
        ./bin/clang --version | head -3
        echo ""
        
        echo "2. Testing Android target (simple code, no headers):"
        cat > test_simple.c << 'CCODE'
        int android_test(int x) {
            return x * 2;
        }
        CCODE
        
        ./bin/clang -target aarch64-linux-android21 -c test_simple.c -o test.o
        
        if [ $? -eq 0 ] && [ -f "test.o" ]; then
            echo "✅ SUCCESS: Cross-compiler core works"
            
            if file test.o | grep -q "ARM aarch64"; then
                echo "✅ Produces ARM64 Android binaries"
            fi
        else
            echo "❌ Basic cross-compilation failed"
            exit 1
        fi
        
        echo ""
        echo "3. Testing OLLVM:"
        ./bin/clang -target aarch64-linux-android21 -mllvm -fla -c test_simple.c -o test_ollvm.o
        
        if [ $? -eq 0 ]; then
            echo "✅ OLLVM obfuscation works"
        else
            echo "❌ OLLVM not working"
        fi
        
        rm -f test_simple.c test.o test_ollvm.o 2>/dev/null
        echo ""
        echo "=== IMPORTANT ==="
        echo "For full Android compilation with headers, you need:"
        echo "1. Android NDK sysroot (set ANDROID_SYSROOT)"
        echo "2. Use: ./bin/android-clang your_code.c"
        echo "3. Or: ./bin/clang -target aarch64-linux-android21 --sysroot=/path/to/ndk/sysroot your_code.c"
        EOF
        
        chmod +x android-arm64-ollvm-cc/verify.sh
        
        # Create proper README
        cat > android-arm64-ollvm-cc/README.md << 'EOF'
        # Android ARM64 OLLVM Cross-Compiler
        
        ## What This Is:
        - **Clang compiler** that runs on x86_64 Linux
        - **Targets Android ARM64** (AArch64)
        - **OLLVM obfuscation** built-in
        - **REQUIRES Android NDK** for headers and libraries
        
        ## Prerequisites:
        1. Download Android NDK: https://developer.android.com/ndk
        2. Extract it somewhere
        
        ## Usage:
        
        ### Method 1: Using wrapper script (recommended):
        ```bash
        export ANDROID_SYSROOT=/path/to/android-ndk/sysroot
        ./bin/android-clang -mllvm -fla -mllvm -sub app.c -o app
        ```
        
        ### Method 2: Manual flags:
        ```bash
        ./bin/clang \
          -target aarch64-linux-android21 \
          --sysroot=/path/to/android-ndk/sysroot \
          -mllvm -fla \
          -mllvm -sub \
          app.c -o app
        ```
        
        ### OLLVM Options:
        ```bash
        -mllvm -fla      # Control Flow Flattening
        -mllvm -sub      # Instruction Substitution
        -mllvm -bcf      # Bogus Control Flow
        -mllvm -sobf     # String Obfuscation
        -mllvm -split    # Basic Block Splitting
        ```
        
        ## Verify Installation:
        ```bash
        ./verify.sh
        ```
        
        ## Note:
        This compiler produces Android ARM64 binaries but needs
        Android NDK's sysroot for headers and libraries.
        EOF
        
        # Package
        tar -czf android-arm64-ollvm-cross.tar.gz android-arm64-ollvm-cc/
        
        echo "✅ Android ARM64 cross-compiler package created"
        ls -lh android-arm64-ollvm-cross.tar.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-arm64-ollvm-cross-compiler
        path: android-arm64-ollvm-cross.tar.gz
        retention-days: 30
