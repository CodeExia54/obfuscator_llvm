name: Build Android ARM64 Cross-Compiler with OLLVM

on:
  workflow_dispatch:
  push:
    branches: [ release/14.x ]

jobs:
  build-android-arm64-cross:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout OLLVM
      uses: actions/checkout@v4
      with:
        repository: sr-tream/obfuscator
        ref: release/14.x
        submodules: recursive

    - name: Apply OLLVM patch
      run: |
        cd llvm-project
        git apply ../obfuscator.patch
        echo "✅ OLLVM obfuscation patches applied"

    - name: Install build tools
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          ninja-build \
          git \
          python3 \
          lld

    - name: Configure Android ARM64 cross-compiler
      run: |
        mkdir -p build
        cd build
        
        # Single line CMake command to avoid line break issues
        cmake ../llvm-project/llvm -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_PROJECTS="clang" -DCMAKE_HOST_SYSTEM_PROCESSOR="x86_64" -DLLVM_HOST_TRIPLE="x86_64-unknown-linux-gnu" -DLLVM_TARGETS_TO_BUILD="AArch64" -DLLVM_DEFAULT_TARGET_TRIPLE="aarch64-linux-android" -DCMAKE_SYSTEM_NAME="Linux" -DCMAKE_SYSTEM_PROCESSOR="aarch64" -DLLVM_ENABLE_RUNTIMES="" -DLLVM_INCLUDE_TESTS=OFF -DLLVM_INCLUDE_EXAMPLES=OFF -DLLVM_BUILD_TOOLS=OFF -DLLVM_ENABLE_LLD=ON -G "Ninja"
        
        echo "✅ Configured: x86_64 → Android ARM64 cross-compiler with OLLVM"

    - name: Build clang cross-compiler
      run: |
        cd build
        ninja clang -j$(nproc)
        echo "✅ Android ARM64 cross-compiler built"

    - name: Verify cross-compiler architecture
      run: |
        echo "=== Checking clang binary ==="
        file build/bin/clang
        echo ""
        
        # It should say: "ELF 64-bit LSB executable, x86-64"
        # NOT "ARM aarch64"
        
        echo "Clang is built for: $(file build/bin/clang | grep -o "x86-64\|ARM aarch64" || echo "unknown")"
        echo ""
        
        if file build/bin/clang | grep -q "x86-64"; then
          echo "✅ CORRECT: clang runs on x86_64 (host)"
        else
          echo "❌ WRONG: clang is not x86_64"
          exit 1
        fi

    - name: Test Android ARM64 compilation
      run: |
        export PATH=$PWD/build/bin:$PATH
        
        echo "=== Testing Android ARM64 target ==="
        
        # Create test program
        cat > test_android.c << 'EOF'
        #include <stdio.h>
        
        int calculate(int a, int b) {
            return a * b + 42;
        }
        
        int main() {
            printf("Result: %d\n", calculate(5, 3));
            return 0;
        }
        EOF
        
        echo "1. Compile for Android ARM64 (API 21):"
        clang -target aarch64-linux-android21 -c test_android.c -o test_android.o
        
        if [ $? -eq 0 ] && [ -f "test_android.o" ]; then
          echo "✅ SUCCESS: Can compile Android ARM64 code"
          echo "Output file:"
          file test_android.o
          
          # Verify it's ARM64
          if file test_android.o | grep -q "ARM aarch64"; then
            echo "✅ CONFIRMED: Produces ARM64 binaries"
          else
            echo "❌ ERROR: Not producing ARM64"
            exit 1
          fi
        else
          echo "❌ FAILED: Cannot compile for Android ARM64"
          exit 1
        fi
        
        echo ""
        echo "2. Test OLLVM obfuscation on Android ARM64:"
        clang -target aarch64-linux-android21 -mllvm -fla -c test_android.c -o test_ollvm.o
        
        if [ $? -eq 0 ]; then
          echo "✅ OLLVM Control Flow Flattening works"
          
          # Compare sizes
          if [ -f "test_android.o" ] && [ -f "test_ollvm.o" ]; then
            NORMAL_SIZE=$(stat -c%s test_android.o)
            OLLVM_SIZE=$(stat -c%s test_ollvm.o)
            
            if [ $OLLVM_SIZE -gt $NORMAL_SIZE ]; then
              INCREASE=$(( (OLLVM_SIZE * 100) / NORMAL_SIZE - 100 ))
              echo "✅ OLLVM increases size by $INCREASE% (expected)"
            fi
          fi
        fi
        
        echo ""
        echo "3. Test all OLLVM features:"
        clang -target aarch64-linux-android21 \
          -mllvm -fla \
          -mllvm -sub \
          -mllvm -bcf \
          -c test_android.c -o test_all_ollvm.o 2>&1
        
        if [ $? -eq 0 ]; then
          echo "✅ All OLLVM features work on Android ARM64"
        fi

    - name: Create cross-compiler package
      run: |
        mkdir -p android-arm64-ollvm-cc
        mkdir -p android-arm64-ollvm-cc/bin
        
        # Copy the cross-compiler
        cp build/bin/clang android-arm64-ollvm-cc/bin/
        cp build/bin/clang++ android-arm64-ollvm-cc/bin/
        
        # Create verification script
        cat > android-arm64-ollvm-cc/verify.sh << 'EOF'
        #!/bin/bash
        echo "=== Android ARM64 OLLVM Cross-Compiler Verification ==="
        echo ""
        
        echo "1. Host architecture (where clang runs):"
        ./bin/clang --version | head -3
        echo ""
        
        echo "2. Testing Android ARM64 target:"
        cat > test.c << 'CCODE'
        int android_function(int x, int y) {
            int sum = 0;
            for (int i = 0; i < x; i++) {
                sum += y * i;
            }
            return sum;
        }
        CCODE
        
        # Compile for Android ARM64
        ./bin/clang -target aarch64-linux-android21 -c test.c -o test.o 2>&1
        
        if [ $? -eq 0 ] && [ -f "test.o" ]; then
            echo "✅ SUCCESS: Cross-compiler works"
            
            # Check architecture
            if file test.o | grep -q "ARM aarch64"; then
                echo "✅ Produces ARM64 Android binaries"
            else
                echo "Output file type:"
                file test.o
            fi
        else
            echo "❌ FAILED: Not a working Android ARM64 cross-compiler"
            exit 1
        fi
        
        echo ""
        echo "3. Testing OLLVM obfuscation:"
        ./bin/clang -target aarch64-linux-android21 -mllvm -fla -mllvm -sub -c test.c -o test_ollvm.o 2>&1
        
        if [ $? -eq 0 ]; then
            echo "✅ OLLVM obfuscation is working"
            
            # Show size difference
            if [ -f "test.o" ] && [ -f "test_ollvm.o" ]; then
                NORMAL=$(stat -c%s test.o 2>/dev/null || echo 0)
                OLLVM=$(stat -c%s test_ollvm.o 2>/dev/null || echo 0)
                
                if [ $NORMAL -gt 0 ] && [ $OLLVM -gt $NORMAL ]; then
                    INCREASE=$(( (OLLVM * 100) / NORMAL - 100 ))
                    echo "✅ Obfuscation increases size by $INCREASE%"
                fi
            fi
        else
            echo "❌ OLLVM not working"
        fi
        
        rm -f test.c test.o test_ollvm.o 2>/dev/null
        echo ""
        echo "=== Verification Complete ==="
        echo "This is a cross-compiler that:"
        echo "1. Runs on x86_64 Linux"
        echo "2. Compiles code for Android ARM64"
        echo "3. Includes OLLVM obfuscation"
        EOF
        
        chmod +x android-arm64-ollvm-cc/verify.sh
        
        # Create usage examples
        cat > android-arm64-ollvm-cc/USAGE.md << 'EOF'
        # Android ARM64 OLLVM Cross-Compiler
        
        ## What this is:
        - **Clang compiler** that runs on x86_64 Linux
        - **Produces Android ARM64** (AArch64) binaries
        - **OLLVM obfuscation** built-in
        
        ## Usage:
        
        ### Basic Android ARM64 compilation:
        ```bash
        ./bin/clang -target aarch64-linux-android21 app.c -o app
        ```
        
        ### With OLLVM obfuscation:
        ```bash
        ./bin/clang -target aarch64-linux-android21 \
          -mllvm -fla \
          -mllvm -sub \
          app.c -o obfuscated_app
        ```
        
        ### Advanced OLLVM options:
        ```bash
        # Control Flow Flattening with splitting
        -mllvm -fla -mllvm -split -mllvm -split_num=3
        
        # Instruction Substitution with loops
        -mllvm -sub -mllvm -sub_loop=2
        
        # Bogus Control Flow with probability
        -mllvm -bcf -mllvm -bcf_loop=3 -mllvm -bcf_prob=40
        
        # String obfuscation
        -mllvm -sobf
        
        # All together
        -mllvm -fla -mllvm -sub -mllvm -bcf -mllvm -sobf
        ```
        
        ### Android API levels:
        ```bash
        # Android 5.0+ (API 21)
        -target aarch64-linux-android21
        
        # Android 7.0+ (API 24)
        -target aarch64-linux-android24
        
        # Android 10+ (API 29)
        -target aarch64-linux-android29
        
        # Android 13+ (API 33)
        -target aarch64-linux-android33
        ```
        
        ## Verify:
        ```bash
        ./verify.sh
        ```
        EOF
        
        # Package
        tar -czf android-arm64-ollvm-cross.tar.gz android-arm64-ollvm-cc/
        
        echo "✅ Android ARM64 cross-compiler package created"
        ls -lh android-arm64-ollvm-cross.tar.gz

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-arm64-ollvm-cross-compiler
        path: android-arm64-ollvm-cross.tar.gz
        retention-days: 30
